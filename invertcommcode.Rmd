---
title: "Jennings Invertrbrate Community"
author: "crc31 Cosgrove"
date: "4 October 2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r combine datasets}
#Combine the four individual CSVs from each sample date
#Note to self: never do in a new tab what you can do in a new column...

#smartbind in gtools can combine datasets
library(gtools)

##Load invert community files and merge them into one csv file.
date4=read.csv("C:/Users/crc31/Dropbox/Jennings Invertebrates/beerbottles_10.15.16.csv")
date4[is.na(date4)]<-0
date4=date4[c(1:93),c(1:129)]
date3=read.csv("C:/Users/crc31/Dropbox/Jennings Invertebrates/beerbottles_8.10.16.csv")
date3[is.na(date3)]<-0
date3=date3[c(1:95),c(1:115)]
date2=read.csv("C:/Users/crc31/Dropbox/Jennings Invertebrates/beerbottles_5.15.16.csv")
date2[is.na(date2)]<-0
date2=date2[c(1:95),c(1:117)]
date1=read.csv("C:/Users/crc31/Dropbox/Jennings Invertebrates/beerbottles_10.6.15.csv")
date1[is.na(date1)]<-0
date1=date1[c(1:91),c(1:80)]
colnames(date1)

commdata=smartbind(date1,date2,date3,date4)
write.csv(commdata)

#Once datasets are combined, check to make sure no misspellings in col names
colnames(commdata)

#remove any NAs
is.na(commdata[,1])
#91,186,281,374 = rows with all NA's
commdata=commdata[-c(91,186,281,374),]
commdata[is.na(commdata)]<-0
is.na(commdata)

#write.csv(commdata,"invertcommdata2.csv")
```

or the EntSA poster:
1. Totals by ecosystem, data
2. Gamma diversity between ecosystems
3. RDA


```{r Load data}
#Load Data
commdata=read.csv("C:/Users/crc31/OneDrive/Documents/School/Research/Data/Inverts/invertcomm/invertcommdata.csv", header=T)
treedata=read.csv("C:/Users/crc31/Dropbox/Jennings 2016/New Adult Basal Area.csv")
soildata=read.csv("C:/Users/crc31/OneDrive/Documents/School/Grad School/SpatialStats/soil data May 08 for tree plots.csv")
flying.ffg=read.csv("C:/Users/crc31/Dropbox/Jennings Invertebrates/flyingFFG.csv")
dim(soildata)
treedata[is.na(treedata)] <- 0
treedata=treedata[treedata$ecosys!="S",] #Remove the stream plots -- Will need to put these back in when I fix the commdata$ecosystem columns.
dim(treedata)
##Tree SPP which are OVER 1% of total basal area: ACERUB, ACESAC, CARCOR, CAROVA, FAGAME, FRAAME, LIRTUP, PLAOCC, POPDEL, PRUSER, QUEALB, QUEPAL, QUERUB, TILAME

##Combine tree data and hellinger transform
tree.ringsum=treedata[1:83,]
for(i in 1:83) {
	tree.ringsum3=treedata[i,10:42]+treedata[i+83,10:42]+treedata[i+166,10:42]  }
for(i in 1:83) {
	tree.ringsum2=treedata[i,10:42]+treedata[i+83,10:42] }
for(i in 1:83) {
	tree.ringsum1=treedata[i,10:42] }
rownames(tree.ringsum)=tree.ringsum[,1]

tree.rowsums=apply(tree.ringsum[10:42],1,sum)
tree.hel=tree.ringsum
tree.hel[,10:42]=tree.hel[,10:42]/tree.rowsums
tree.hel[,10:42]=sqrt(tree.hel[,10:42])

## Load libraries - Do I even need all of these?
library(vegan)
library(nlme)
library(ggplot2)
library(lme4)
dim(commdata)

#merge soil and tree data with commdata
commdata=merge(commdata,soildata, by="Plot")
commdata=merge(commdata,tree.hel)

#Separate out dates for future lines of code:
date4=commdata[commdata$Date=="10.15.16",]
date2=commdata[commdata$Date=="5.5.16",]
date3=commdata[commdata$Date=="8.10.16",]
date1=commdata[commdata$Date=="10.6.15",]
```

```{r Exploratory Stats}
#General summation and graph by date
sum(commdata$Total) #Total=99517 individuals
plot(commdata$Total~commdata$Date) #Most individuals in falls
dateordered=ordered(commdata$Date, levels = c("10.6.15","5.5.16","8.10.16","10.15.16"))
sumplot=boxplot(commdata$Total~dateordered, xlab="Date", ylab="Average Site Sum")
sumplot2=boxplot(commdata$Total~dateordered, xlab="Date", ylab="Average Site Sum", ylim=c(0,1000))



ecoplot=plot(commdata$Total~commdata$Habitat, xlab="Ecosystem", ylab="Average Ecosystem Sum")
ecoplot2=plot(commdata$Total~commdata$Habitat, xlab="Ecosystem", ylab="Average Ecosystem Sum", ylim=c(0,1000))

#abundance by date and ecosystem
abund=aov(commdata$Total~commdata$Habitat*commdata$Date)
summary(abund)
plot(abund)
shapiro.test(commdata$Total)
#shapiro.test is super non-normal; log transform best transforms the datam but not great..
sqtot=lm(commdata$Total)
abund1=aov(sqtot~commdata$Habitat*commdata$Date)
summary(abund1)
plot(abund1)
shapiro.test(sqtot)
TukeyHSD(abund1)


#sum by date and ecosystem
date4=commdata[commdata$Date=="10.15.16",]
sum(date4$Total)
date2=commdata[commdata$Date=="5.5.16",]
sum(date2$Total)
date3=commdata[commdata$Date=="8.10.16",]
sum(date3$Total)
date1=commdata[commdata$Date=="10.6.15",]
sum(date1$Total)



#Rank abundance
totalrs=apply(commdata[,8:158],2,sum)
plot(rank(totalrs),totalrs, xlab="invert species", xlim=c(1,158))
plot(rank(totalrs),totalrs, xlab="invert species", xlim=c(1,158), ylim=c(0,2500))

```

```{r Diversity}
#Gamma diversity between ecosystems
rownames(date1)=date1[,1]
dim(date1)
Hdate1=diversity(date1[1:89,8:158])
raredate1=rarefy(date1[,8:158], 2)-1
specno=specnumber(commdata[8:158], MARGIN=1)

botrich=lme(specno~as.factor(TerrType)*Date+Plot,random=~1, data=commdata)
summary(botrich)
TukeyHSD(botrich)
shapiro.test(specscno)

#Alpha
alpha1=fisher.alpha(date1[,8:158])
alpha2=fisher.alpha(date2[,8:158])
alpha3=fisher.alpha(date3[,8:158])
alpha4=fisher.alpha(date4[,8:158])
boxplot(alpha1)
plot(alpha2)
plot(alpha3)
plot(alpha4)


#Gamma
gammadiv=with(date1, tapply(specnumber(date1[,8:158]),Habitat))
plot(gammadiv)
gamma2=with(date2, tapply(specnumber(date2[,8:158]),Habitat))
gamma3=with(date3, tapply(specnumber(date3[,8:158]),Habitat))
gamma4=with(date4, tapply(specnumber(date4[,8:158]),Habitat))
plot(gammadiv,gamma2,gamma3,gamma4)
#Beta
alpha1 <- with(date1, tapply(specnumber(date1[,8:158]), Habitat, mean))
alpha2 <- with(date2, tapply(specnumber(date2[,8:158]), Habitat, mean))
alpha3 <- with(date3, tapply(specnumber(date3[,8:158]), Habitat, mean))
alpha4 <- with(date4, tapply(specnumber(date4[,8:158]), Habitat, mean))
beta1=gammadiv/alpha1-1
beta2=gamma2/alpha2-1
beta3=gamma3/alpha3-1
beta4=gamma4/alpha4-1

boxplot(alpha1,alpha2,alpha3,alpha4, xlab="Date", ylab="Species Richness")
mtext(side=1,at=1,"6 Oct 2015",las=2,line=1, srt=45)
mtext(side=1,at=2,"5 May 2016",las=2,line=1)
mtext(side=1,at=3,"10 Aug 2016",las=2,line=1)
mtext(side=1,at=4,"15 Oct 2016",las=2,line=1)
labels=lab, srt=45, adj=1, xpd=TRUE)

richness(date1[,8:158])


##Real stats or something
colnames(date1)
dim(date1)
rownames(date1)=date1[,1]
Hdate1=diversity(date1[8:158], index="shannon")
rownames(date2)=date2[,1]
Hdate2=diversity(date2[8:158], index="shannon")
rownames(date3)=date3[,1]
Hdate3=diversity(date3[8:158], index="shannon")
rownames(date4)=date4[,1]
Hdate4=diversity(date4[8:158], index="shannon")
boxplot(Hdate1, Hdate2, Hdate3, Hdate4, xlab="Date", ylab="Shannon's Index")
mtext(side=1,at=1,"6 Oct 2015",las=2,line=1, srt=45)
mtext(side=1,at=2,"5 May 2016",las=2,line=1)
mtext(side=1,at=3,"10 Aug 2016",las=2,line=1)
mtext(side=1,at=4,"15 Oct 2016",las=2,line=1)


#shannon's diversity by ecosystem type
bot=commdata[commdata$TerrType=="B",]
b1=bot[bot$Date=="10.6.15",]
b2=bot[bot$Date=="5.5.16",]
b3=bot[bot$Date=="8.10.16",]
b4=bot[bot$Date=="10.15.16",]
dim(bot)
Hbot=diversity(bot[8:158], index="shannon")
hb1=diversity(b1[8:158], index="shannon")
hb2=diversity(b2[8:158], index="shannon")
hb3=diversity(b3[8:158], index="shannon")
hb4=diversity(b4[8:158], index="shannon")
boxplot(Hbot,hb1, hb2, hb3, hb4, xlab="bottomland diversity", ylab="shannons diversity")
mtext(side=1,at=1,"All Dates",las=2,line=1, srt=45)
mtext(side=1,at=2,"6 Oct 2015",las=2,line=1, srt=45)
mtext(side=1,at=3,"5 May 2016",las=2,line=1)
mtext(side=1,at=4,"10 Aug 2016",las=2,line=1)
mtext(side=1,at=5,"15 Oct 2016",las=2,line=1)


srb1=specnumber(b1[8:158], MARGIN=1)
srb2=specnumber(b2[8:158], MARGIN=1)
srb3=specnumber(b3[8:158], MARGIN=1)
srb4=specnumber(b4[8:158], MARGIN=1)
boxplot(srb1,srb2,srb3,srb4, xlab="bottomland richness", ylab="species richness")
mtext(side=1,at=1,"6 Oct 2015",las=2,line=1, srt=45)
mtext(side=1,at=2,"5 May 2016",las=2,line=1)
mtext(side=1,at=3,"10 Aug 2016",las=2,line=1)
mtext(side=1,at=4,"15 Oct 2016",las=2,line=1)


rip=commdata[commdata$TerrType=="R",]
r1=rip[rip$Date=="10.6.15",]
r2=rip[rip$Date=="5.5.16",]
r3=rip[rip$Date=="8.10.16",]
r4=rip[rip$Date=="10.15.16",]
Hrip=diversity(rip[8:158], index="shannon")
hr1=diversity(r1[8:158], index="shannon")
hr2=diversity(r2[8:158], index="shannon")
hr3=diversity(r3[8:158], index="shannon")
hr4=diversity(r4[8:158], index="shannon")
boxplot(Hrip, hr1, hr2, hr3, hr4, xlab="riparian diversity", ylab="shannons diversity")
mtext(side=1,at=1,"All Dates",las=2,line=1, srt=45)
mtext(side=1,at=2,"6 Oct 2015",las=2,line=1, srt=45)
mtext(side=1,at=3,"5 May 2016",las=2,line=1)
mtext(side=1,at=4,"10 Aug 2016",las=2,line=1)
mtext(side=1,at=5,"15 Oct 2016",las=2,line=1)


srr1=specnumber(r1[8:158], MARGIN=1)
srr2=specnumber(r2[8:158], MARGIN=1)
srr3=specnumber(r3[8:158], MARGIN=1)
srr4=specnumber(r4[8:158], MARGIN=1)
boxplot(srr1,srr2,srr3,srr4, xlab="riparian richness", ylab="species richness")
mtext(side=1,at=1,"6 Oct 2015",las=2,line=1, srt=45)
mtext(side=1,at=2,"5 May 2016",las=2,line=1)
mtext(side=1,at=3,"10 Aug 2016",las=2,line=1)
mtext(side=1,at=4,"15 Oct 2016",las=2,line=1)


upl=commdata[commdata$TerrType=="U",]
u1=upl[upl$Date=="10.6.15",]
u2=upl[upl$Date=="5.5.16",]
u3=upl[upl$Date=="8.10.16",]
u4=upl[upl$Date=="10.15.16",]
Hupl=diversity(upl[8:158], index="shannon")
hu1=diversity(u1[8:158], index="shannon")
hu2=diversity(u2[8:158], index="shannon")
hu3=diversity(u3[8:158], index="shannon")
hu4=diversity(u4[8:158], index="shannon")
boxplot(Hupl,hu1, hu2, hu3, hu4, xlab="upland diversity", ylab="shannons diversity")
mtext(side=1,at=1,"All Dates",las=2,line=1, srt=45)
mtext(side=1,at=2,"6 Oct 2015",las=2,line=1, srt=45)
mtext(side=1,at=3,"5 May 2016",las=2,line=1)
mtext(side=1,at=4,"10 Aug 2016",las=2,line=1)
mtext(side=1,at=5,"15 Oct 2016",las=2,line=1)


sru1=specnumber(u1[8:158], MARGIN=1)
sru2=specnumber(u2[8:158], MARGIN=1)
sru3=specnumber(u3[8:158], MARGIN=1)
sru4=specnumber(u4[8:158], MARGIN=1)
boxplot(sru1,sru2,sru3,sru4, xlab="upland richness", ylab="species richness")
mtext(side=1,at=1,"6 Oct 2015",las=2,line=1, srt=45)
mtext(side=1,at=2,"5 May 2016",las=2,line=1)
mtext(side=1,at=3,"10 Aug 2016",las=2,line=1)
mtext(side=1,at=4,"15 Oct 2016",las=2,line=1)


dis=commdata[commdata$TerrType=="D",]
rownames(dis)=dis[,1]
Hdis=diversity(dis[8:158], index="shannon")

boxplot(Hbot, Hrip, Hupl, Hdis, xlab="Ecosystem", ylab="Shannon's Diversity")
mtext(side=1,at=1,"Bottomland",las=2,line=1, srt=45)
mtext(side=1,at=2,"Riparian",las=2,line=1)
mtext(side=1,at=3,"Upland",las=2,line=1)
mtext(side=1,at=4,"Disturbed",las=2,line=1)


halp=aov(Hbot~bot$Date+bot$Plot)
summary(halp)
TukeyHSD(halp)
halp=aov(Hrip~rip$Date+rip$Plot)
summary(halp)
halp=aov(Hupl~upl$Date+upl$Plot)
summary(halp)
halp=aov(Hdis~dis$Date+dis$Plot)
summary(halp)

##Ecotone Diversity and Richness
#uplbot
uplbot=commdata[commdata$TerrType=="UB"|commdata$TerrType=="BU",]
dim(uplbot)
ub1=uplbot[uplbot$Date=="10.6.15",]
ub2=uplbot[uplbot$Date=="5.5.16",]
ub3=uplbot[uplbot$Date=="8.10.16",]
ub4=uplbot[uplbot$Date=="10.15.16",]

ubdall=diversity(uplbot[8:158], index="shannon")
ubd1=diversity(ub1[8:158], index="shannon")
ubd2=diversity(ub2[8:158], index="shannon")
ubd3=diversity(ub3[8:158], index="shannon")
ubd4=diversity(ub4[8:158], index="shannon")
boxplot(ubdall, ubd1, ubd2, ubd3, ubd4, xlab="ub diversity", ylab="shannons diversity")
mtext(side=1,at=1,"All Dates",las=2,line=1, srt=45)
mtext(side=1,at=2,"6 Oct 2015",las=2,line=1, srt=45)
mtext(side=1,at=3,"5 May 2016",las=2,line=1)
mtext(side=1,at=4,"10 Aug 2016",las=2,line=1)
mtext(side=1,at=5,"15 Oct 2016",las=2,line=1)

ubr1=specnumber(u1[8:158], MARGIN=1)
ubr2=specnumber(u2[8:158], MARGIN=1)
ubr3=specnumber(u3[8:158], MARGIN=1)
ubr4=specnumber(u4[8:158], MARGIN=1)
boxplot(ubr1,ubr2,ubr3,ubr4, xlab="UB spp richness", ylab="species richness")
mtext(side=1,at=1,"6 Oct 2015",las=2,line=1, srt=45)
mtext(side=1,at=2,"5 May 2016",las=2,line=1)
mtext(side=1,at=3,"10 Aug 2016",las=2,line=1)
mtext(side=1,at=4,"15 Oct 2016",las=2,line=1)

#ripbot
ripbot=commdata[commdata$TerrType=="RB"|commdata$TerrType=="BR",]
rb1=ripbot[ripbot$Date=="10.6.15",]
rb2=ripbot[ripbot$Date=="5.5.16",]
rb3=ripbot[ripbot$Date=="8.10.16",]
rb4=ripbot[ripbot$Date=="10.15.16",]

rbdall=diversity(ripbot[8:158], index="shannon")
rbd1=diversity(rb1[8:158], index="shannon")
rbd2=diversity(rb2[8:158], index="shannon")
rbd3=diversity(rb3[8:158], index="shannon")
rbd4=diversity(rb4[8:158], index="shannon")
boxplot(rbdall, rbd1, rbd2, rbd3, rbd4, xlab="RB diversity", ylab="shannons diversity")
mtext(side=1,at=1,"All Dates",las=2,line=1, srt=45)
mtext(side=1,at=2,"6 Oct 2015",las=2,line=1, srt=45)
mtext(side=1,at=3,"5 May 2016",las=2,line=1)
mtext(side=1,at=4,"10 Aug 2016",las=2,line=1)
mtext(side=1,at=5,"15 Oct 2016",las=2,line=1)

rbr1=specnumber(u1[8:158], MARGIN=1)
rbr2=specnumber(u2[8:158], MARGIN=1)
rbr3=specnumber(u3[8:158], MARGIN=1)
rbr4=specnumber(u4[8:158], MARGIN=1)
boxplot(rbr1,rbr2,rbr3,rbr4, xlab="RB spp richness", ylab="species richness")
mtext(side=1,at=1,"6 Oct 2015",las=2,line=1, srt=45)
mtext(side=1,at=2,"5 May 2016",las=2,line=1)
mtext(side=1,at=3,"10 Aug 2016",las=2,line=1)
mtext(side=1,at=4,"15 Oct 2016",las=2,line=1)

#uplrip
uplrip=commdata[commdata$TerrType=="UR"|commdata$TerrType=="RU",]
ur1=uplrip[uplrip$Date=="10.6.15",]
ur2=uplrip[uplrip$Date=="5.5.16",]
ur3=uplrip[uplrip$Date=="8.10.16",]
ur4=uplrip[uplrip$Date=="10.15.16",]

urdall=diversity(uplrip[8:158], index="shannon")
urd1=diversity(ur1[8:158], index="shannon")
urd2=diversity(ur2[8:158], index="shannon")
urd3=diversity(ur3[8:158], index="shannon")
urd4=diversity(ur4[8:158], index="shannon")
boxplot(urdall,urd1, urd2, urd3, urd4, xlab="ur diversity", ylab="shannons diversity")
mtext(side=1,at=1,"All Dates",las=2,line=1, srt=45)
mtext(side=1,at=2,"6 Oct 2015",las=2,line=1, srt=45)
mtext(side=1,at=3,"5 May 2016",las=2,line=1)
mtext(side=1,at=4,"10 Aug 2016",las=2,line=1)
mtext(side=1,at=5,"15 Oct 2016",las=2,line=1)


urr1=specnumber(u1[8:158], MARGIN=1)
urr2=specnumber(u2[8:158], MARGIN=1)
urr3=specnumber(u3[8:158], MARGIN=1)
urr4=specnumber(u4[8:158], MARGIN=1)
srripupl=boxplot(urr1, urr2, urr3, urr4, xlab="ur spp richness", ylab="species richness")
mtext(side=1,at=1,"6 Oct 2015",las=2,line=1, srt=45)
mtext(side=1,at=2,"5 May 2016",las=2,line=1)
mtext(side=1,at=3,"10 Aug 2016",las=2,line=1)
mtext(side=1,at=4,"15 Oct 2016",las=2,line=1)

boxplot(hu4, urd4, hr4, xlab="Ecosystem", ylab="Shannons diversity")
mtext(side=1,at=1,"U",las=2,line=1, srt=45)
mtext(side=1,at=2,"UR",las=2,line=1)
mtext(side=1,at=3,"R",las=2,line=1)

boxplot(sru4, urr4, srr4, xlab="Ecosystem", ylab="species richness")
mtext(side=1,at=1,"U",las=2,line=1, srt=45)
mtext(side=1,at=2,"UR",las=2,line=1)
mtext(side=1,at=3,"R",las=2,line=1)



####GRAHING FOR ESA
boxplot(hr1, hr2, hr3, hr4, ylab="Shannon's Diversity")
title(main = "Riparian")

boxplot(srr1,srr2,srr3,srr4, xlab="Date", ylab="Taxonomic Richness", ylim=c(5,25))
mtext(side=1,at=1,"6 Oct 2015",las=0,line=1, srt=45)
mtext(side=1,at=2,"5 May 2016",las=0,line=1)
mtext(side=1,at=3,"10 Aug 2016",las=0,line=1)
mtext(side=1,at=4,"15 Oct 2016",las=0,line=1)

boxplot(urd1, urd2, urd3, urd4, xlab="") #Ecotone Diversity
title(main="Riparian-Upland")


srripupl=boxplot(urr1, urr2, urr3, urr4, xlab="Date") #SR RipUpl
mtext(side=1,at=1,"6 Oct 2015",las=0,line=1, srt=45)
mtext(side=1,at=2,"5 May 2016",las=0,line=1)
mtext(side=1,at=3,"10 Aug 2016",las=0,line=1)
mtext(side=1,at=4,"15 Oct 2016",las=0,line=1)

boxplot(hu1, hu2, hu3, hu4, xlab="") #Upland Diversity
title(main="Upland")

boxplot(sru1,sru2,sru3,sru4, xlab="Date", main="Upland")
mtext(side=1,at=1,"6 Oct 2015",las=0,line=1, srt=45)
mtext(side=1,at=2,"5 May 2016",las=0,line=1)
mtext(side=1,at=3,"10 Aug 2016",las=0,line=1)
mtext(side=1,at=4,"15 Oct 2016",las=0,line=1)



###
commdata.core=commdata[commdata$EP=="Core",]
dim(commdata.core)
halldates=diversity(commdata.core[,8:158], index="shannon")
alldates=lme(halldates~Habitat*Date, random = ~ 1|Plot, data=commdata.core)
anova(alldates)

sralldates=specnumber(commdata.core[8:158], MARGIN=1)
datesall=lme(sralldates~Habitat*Date, random=~1|Plot, data=commdata.core)
anova(datesall)

commdata.edge=commdata[commdata$EP!="Trans",]
commdata.edge=commdata.edge[commdata.edge$Habitat!="UR",]
dim(commdata.edge)

halldates1=diversity(commdata.edge[8:158], index="shannon")
alldates1=lme(halldates1~Habitat*Date, random = ~ 1|Plot, data=commdata.edge)
anova(alldates1)

sralldates1=specnumber(commdata.edge[8:158], MARGIN=1)
datesall1=lme(sralldates1~Habitat*Date, random=~1|Plot, data=commdata.edge)
anova(datesall1)
summary(datesall1)

commdata.edge$Habitat
colnames(commdata)
commdata$Habitat


colnames(commdata)=commdata[1,]
lme(Hdate1~Habitat+Plot, data=date1)
```


```{r RDA DATE1}
## Remove fruitflies from the analyses
rdadate1=commdata[commdata$Date=="10.6.15",which(colnames(commdata)!="Drosophilidae..Drosophila"&colnames(commdata)!="Drosophilidae..Microdrosophila"&colnames(commdata)!="Drosophilidae..Mycodrosophila")]
dim(rdadate1)

#### All plots
tree.hel.soil=rdadate1
dim(tree.hel.soil)
rownames(tree.hel.soil)=tree.hel.soil[,1]
tree.hel.soil=na.exclude(tree.hel.soil)
# Here is the global analysis. Can proceed  Use adj. R square as additional stopping criterion.
colnames(tree.hel.soil)
dim(tree.hel.soil)

hel.rda.fulsoil = rda(tree.hel.soil[,8:155], tree.hel.soil[,165:189])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERT BY TREE DATA
dim(rdadate1)
hel.rda.fulsoil = rda(tree.hel.soil[,8:155],tree.hel.soil[,c(195:229)])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERTS BY PCMN
#to determine spatial autocorrelation
# First we perform PCNM to get the vectors
colnames(tree.hel.soil)
all.geog.dist=vegdist(tree.hel.soil[,193:194],method="euclid")
all.pcnm1=pcnm(all.geog.dist)
all.pcnmvecs=all.pcnm1$vectors
# If you can get the PCNM library to run, you could do the line below to select only significantly structured PCNMs
#tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs[,which(all.pcnm1$Moran_I[,2]<0.05)])
tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs)
names(tree.hel.all.pcnm)
# Now run step 1, global analysis
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:155], tree.hel.all.pcnm[,231:273])
anova(hel.rda.all.fulpcnm)
RsquareAdj(hel.rda.all.fulpcnm)
global.thresh=RsquareAdj(hel.rda.all.fulpcnm)$adj.r.squared
# now run step 2, the selection part

#forward selection for our PCNM variables
hel.rda.all.pcnm.none=rda(tree.hel.all.pcnm[,8:155]~1)
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:155], tree.hel.all.pcnm[,231:273])

hel.rda.all.pcnm.full=rda(tree.hel.all.pcnm[,8:155]~tree.hel.all.pcnm$PCNM1+tree.hel.all.pcnm$PCNM2+tree.hel.all.pcnm$PCNM3+tree.hel.all.pcnm$PCNM4+tree.hel.all.pcnm$PCNM5+tree.hel.all.pcnm$PCNM6+tree.hel.all.pcnm$PCNM7+tree.hel.all.pcnm$PCNM8+tree.hel.all.pcnm$PCNM9+tree.hel.all.pcnm$PCNM10+tree.hel.all.pcnm$PCNM11+tree.hel.all.pcnm$PCNM12+tree.hel.all.pcnm$PCNM13+tree.hel.all.pcnm$PCNM14+tree.hel.all.pcnm$PCNM15+tree.hel.all.pcnm$PCNM16+tree.hel.all.pcnm$PCNM17+tree.hel.all.pcnm$PCNM18+tree.hel.all.pcnm$PCNM19+tree.hel.all.pcnm$PCNM20+tree.hel.all.pcnm$PCNM21+tree.hel.all.pcnm$PCNM22+tree.hel.all.pcnm$PCNM23+tree.hel.all.pcnm$PCNM24+tree.hel.all.pcnm$PCNM25+tree.hel.all.pcnm$PCNM26+tree.hel.all.pcnm$PCNM27+tree.hel.all.pcnm$PCNM28+tree.hel.all.pcnm$PCNM29+tree.hel.all.pcnm$PCNM30+tree.hel.all.pcnm$PCNM31+tree.hel.all.pcnm$PCNM32+tree.hel.all.pcnm$PCNM33+tree.hel.all.pcnm$PCNM34+tree.hel.all.pcnm$PCNM35+tree.hel.all.pcnm$PCNM36+tree.hel.all.pcnm$PCNM37+tree.hel.all.pcnm$PCNM38+tree.hel.all.pcnm$PCNM39+tree.hel.all.pcnm$PCNM40+tree.hel.all.pcnm$PCNM41+tree.hel.all.pcnm$PCNM42+tree.hel.all.pcnm$PCNM43)

tree.sel=ordiR2step(hel.rda.all.pcnm.none,scope=formula(hel.rda.all.pcnm.full),Pin=0.05,R2scope=TRUE)
tree.sel

##Just the variables forward selected
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:155], tree.hel.all.pcnm[,c(234,242,232,235,240)])
anova(hel.rda.all.fulpcnm)
RsquareAdj(hel.rda.all.fulpcnm)
global.thresh=RsquareAdj(hel.rda.all.fulpcnm)$adj.r.squared

##INVERTS BY ECOSYSTEM
hel.rda.fulsoil = rda(rdadate1[,8:155]~rdadate1$Habitat)
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

#### Core plots ####
tree.hel.soil=rdadate1[rdadate1$EP=="Core",]
dim(tree.hel.soil)
rownames(tree.hel.soil)=tree.hel.soil[,1]
tree.hel.soil=na.exclude(tree.hel.soil)
# Here is the global analysis. Can proceed  Use adj. R square as additional stopping criterion.
colnames(tree.hel.soil)
dim(tree.hel.soil)

hel.rda.fulsoil = rda(tree.hel.soil[,8:155], tree.hel.soil[,165:189])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERT BY TREE DATA
dim(rdadate1)
hel.rda.fulsoil = rda(tree.hel.soil[,8:155],tree.hel.soil[,c(195:229)])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERTS BY PCMN
#to determine spatial autocorrelation
# First we perform PCNM to get the vectors
colnames(tree.hel.soil)
all.geog.dist=vegdist(tree.hel.soil[,193:194],method="euclid")
all.pcnm1=pcnm(all.geog.dist)
all.pcnmvecs=all.pcnm1$vectors
# If you can get the PCNM library to run, you could do the line below to select only significantly structured PCNMs
#tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs[,which(all.pcnm1$Moran_I[,2]<0.05)])
tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs)
names(tree.hel.all.pcnm)
# Now run step 1, global analysis
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:155], tree.hel.all.pcnm[,231:254])
anova(hel.rda.all.fulpcnm)
RsquareAdj(hel.rda.all.fulpcnm)
global.thresh=RsquareAdj(hel.rda.all.fulpcnm)$adj.r.squared
# now run step 2, the selection part

#forward selection for our PCNM variables
hel.rda.all.pcnm.none=rda(tree.hel.all.pcnm[,8:155]~1)
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:155], tree.hel.all.pcnm[,231:254])

hel.rda.all.pcnm.full=rda(tree.hel.all.pcnm[,8:155]~tree.hel.all.pcnm$PCNM1+tree.hel.all.pcnm$PCNM2+tree.hel.all.pcnm$PCNM3+tree.hel.all.pcnm$PCNM4+tree.hel.all.pcnm$PCNM5+tree.hel.all.pcnm$PCNM6+tree.hel.all.pcnm$PCNM7+tree.hel.all.pcnm$PCNM8+tree.hel.all.pcnm$PCNM9+tree.hel.all.pcnm$PCNM10+tree.hel.all.pcnm$PCNM11+tree.hel.all.pcnm$PCNM12+tree.hel.all.pcnm$PCNM13+tree.hel.all.pcnm$PCNM14+tree.hel.all.pcnm$PCNM15+tree.hel.all.pcnm$PCNM16+tree.hel.all.pcnm$PCNM17+tree.hel.all.pcnm$PCNM18+tree.hel.all.pcnm$PCNM19+tree.hel.all.pcnm$PCNM20+tree.hel.all.pcnm$PCNM21+tree.hel.all.pcnm$PCNM22+tree.hel.all.pcnm$PCNM23+tree.hel.all.pcnm$PCNM24)

tree.sel=ordiR2step(hel.rda.all.pcnm.none,scope=formula(hel.rda.all.pcnm.full),Pin=0.05,R2scope=TRUE)
tree.sel

##Just the variables forward selected
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:155], tree.hel.all.pcnm[,c(231:232,235)])
anova(hel.rda.all.fulpcnm)
RsquareAdj(hel.rda.all.fulpcnm)
global.thresh=RsquareAdj(hel.rda.all.fulpcnm)$adj.r.squared

##INVERTS BY ECOSYSTEM
hel.rda.fulsoil = rda(tree.hel.soil[,8:155]~tree.hel.soil$Habitat)
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared


#### CORE+EDGE ####
tree.hel.soil=rdadate1[rdadate1$EP=="Core"|rdadate1$EP=="Edge",]
dim(tree.hel.soil)
rownames(tree.hel.soil)=tree.hel.soil[,1]
tree.hel.soil=na.exclude(tree.hel.soil)
# Here is the global analysis. Can proceed  Use adj. R square as additional stopping criterion.
colnames(tree.hel.soil)

hel.rda.fulsoil = rda(tree.hel.soil[,8:155], tree.hel.soil[,165:189])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

##Forward selection
hel.rda.fulsoil.none = rda(tree.hel.soil[,8:155]~1)
hel.rda.fulsoil = rda(tree.hel.soil[,8:155], tree.hel.soil[,165:189])

hel.rda.fulsoil.full=rda(tree.hel.soil[,8:155]~tree.hel.soil$Ptot_long+tree.hel.soil$Po_long+tree.hel.soil$pH_long+tree.hel.soil$moist_long+tree.hel.soil$ps1_long+tree.hel.soil$ps2_long+tree.hel.soil$percc_long+tree.hel.soil$cton_long+tree.hel.soil$Ptot_nug+tree.hel.soil$Po_nug+tree.hel.soil$pH_nug+tree.hel.soil$moist_nug+tree.hel.soil$ps1_nug+tree.hel.soil$ps2_nug+tree.hel.soil$percc_nug+tree.hel.soil$pomc_nug+tree.hel.soil$cton_nug+tree.hel.soil$Ptot_short+tree.hel.soil$Po_short+tree.hel.soil$pH_short+tree.hel.soil$moist_short+tree.hel.soil$ps1_short+tree.hel.soil$percc_short+tree.hel.soil$pomc_short+tree.hel.soil$cton_short)

tree.sel=ordiR2step(hel.rda.fulsoil.none,scope=formula(hel.rda.fulsoil.full),Pin=0.05,R2scope=TRUE)
tree.sel

##Just the variables forward selected
hel.rda.fulsoil = rda(tree.hel.soil[,8:155], tree.hel.soil[,c(172,176)])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERT BY TREE DATA
hel.rda.fulsoil = rda(tree.hel.soil[,8:155],tree.hel.soil[,c(195:229)])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERTS BY PCMN
#to determine spatial autocorrelation
# First we perform PCNM to get the vectors
colnames(tree.hel.soil)
all.geog.dist=vegdist(tree.hel.soil[,193:194],method="euclid")
all.pcnm1=pcnm(all.geog.dist)
all.pcnmvecs=all.pcnm1$vectors
# If you can get the PCNM library to run, you could do the line below to select only significantly structured PCNMs
#tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs[,which(all.pcnm1$Moran_I[,2]<0.05)])
tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs)
names(tree.hel.all.pcnm)
# Now run step 1, global analysis
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:155], tree.hel.all.pcnm[,231:268])
anova(hel.rda.all.fulpcnm)
RsquareAdj(hel.rda.all.fulpcnm)
global.thresh=RsquareAdj(hel.rda.all.fulpcnm)$adj.r.squared
# now run step 2, the selection part

#forward selection for our PCNM variables
hel.rda.all.pcnm.none=rda(tree.hel.all.pcnm[,8:155]~1)
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:155], tree.hel.all.pcnm[,231:268])

hel.rda.all.pcnm.full=rda(tree.hel.all.pcnm[,8:155]~tree.hel.all.pcnm$PCNM1+tree.hel.all.pcnm$PCNM2+tree.hel.all.pcnm$PCNM3+tree.hel.all.pcnm$PCNM4+tree.hel.all.pcnm$PCNM5+tree.hel.all.pcnm$PCNM6+tree.hel.all.pcnm$PCNM7+tree.hel.all.pcnm$PCNM8+tree.hel.all.pcnm$PCNM9+tree.hel.all.pcnm$PCNM10+tree.hel.all.pcnm$PCNM11+tree.hel.all.pcnm$PCNM12+tree.hel.all.pcnm$PCNM13+tree.hel.all.pcnm$PCNM14+tree.hel.all.pcnm$PCNM15+tree.hel.all.pcnm$PCNM16+tree.hel.all.pcnm$PCNM17+tree.hel.all.pcnm$PCNM18+tree.hel.all.pcnm$PCNM19+tree.hel.all.pcnm$PCNM20+tree.hel.all.pcnm$PCNM21+tree.hel.all.pcnm$PCNM22+tree.hel.all.pcnm$PCNM23+tree.hel.all.pcnm$PCNM24+tree.hel.all.pcnm$PCNM25+tree.hel.all.pcnm$PCNM26+tree.hel.all.pcnm$PCNM27+tree.hel.all.pcnm$PCNM28+tree.hel.all.pcnm$PCNM29+tree.hel.all.pcnm$PCNM30+tree.hel.all.pcnm$PCNM31+tree.hel.all.pcnm$PCNM32+tree.hel.all.pcnm$PCNM33+tree.hel.all.pcnm$PCNM34+tree.hel.all.pcnm$PCNM35+tree.hel.all.pcnm$PCNM36+tree.hel.all.pcnm$PCNM37+tree.hel.all.pcnm$PCNM38)

tree.sel=ordiR2step(hel.rda.all.pcnm.none,scope=formula(hel.rda.all.pcnm.full),Pin=0.05,R2scope=TRUE)
tree.sel

##Just the variables forward selected
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:155], tree.hel.all.pcnm[,c(234,254,246,233,241)])
anova(hel.rda.all.fulpcnm)
RsquareAdj(hel.rda.all.fulpcnm)
global.thresh=RsquareAdj(hel.rda.all.fulpcnm)$adj.r.squared

##INVERTS BY ECOSYSTEM
hel.rda.fulsoil = rda(rdadate1[,8:155]~rdadate1$Habitat)
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

## Variance partitioning
varpart(tree.hel.all.pcnm[,8:155], tree.hel.all.pcnm[,c(172,176)], tree.hel.all.pcnm[,c(234,254,246,233,241)])
## Check to see if it's significant when PCNM and soil come first.
hel.rda.all.partpcnm=rda(tree.hel.all.pcnm[,8:155], tree.hel.all.pcnm[,c(172,176)], tree.hel.all.pcnm[,c(234,254,246,233,241)])
anova(hel.rda.all.partpcnm)
# Yes.
hel.rda.all.partsoil=rda(tree.hel.all.pcnm[,8:155], tree.hel.all.pcnm[,c(234,254,246,233,241)], tree.hel.all.pcnm[,c(172,176)])
anova(hel.rda.all.partsoil)
```
```{r RDA DATE2}
## Remove fruitflies from the analyses
rdadate2=commdata[commdata$Date=="5.5.16",which(colnames(commdata)!="Drosophilidae..Drosophila"&colnames(commdata)!="Drosophilidae..Microdrosophila"&colnames(commdata)!="Drosophilidae..Mycodrosophila")]
dim(rdadate2)

#### All plots
tree.hel.soil=rdadate2
dim(tree.hel.soil)
rownames(tree.hel.soil)=tree.hel.soil[,1]
tree.hel.soil=na.exclude(tree.hel.soil)
# Here is the global analysis. Can proceed  Use adj. R square as additional stopping criterion.
colnames(tree.hel.soil)
dim(tree.hel.soil)

hel.rda.fulsoil = rda(tree.hel.soil[,8:155], tree.hel.soil[,165:189])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

##Forward selection
hel.rda.fulsoil.none = rda(tree.hel.soil[,8:155]~1)
hel.rda.fulsoil = rda(tree.hel.soil[,8:155], tree.hel.soil[,165:189])

hel.rda.fulsoil.full=rda(tree.hel.soil[,8:155]~tree.hel.soil$Ptot_long+tree.hel.soil$Po_long+tree.hel.soil$pH_long+tree.hel.soil$moist_long+tree.hel.soil$ps1_long+tree.hel.soil$ps2_long+tree.hel.soil$percc_long+tree.hel.soil$cton_long+tree.hel.soil$Ptot_nug+tree.hel.soil$Po_nug+tree.hel.soil$pH_nug+tree.hel.soil$moist_nug+tree.hel.soil$ps1_nug+tree.hel.soil$ps2_nug+tree.hel.soil$percc_nug+tree.hel.soil$pomc_nug+tree.hel.soil$cton_nug+tree.hel.soil$Ptot_short+tree.hel.soil$Po_short+tree.hel.soil$pH_short+tree.hel.soil$moist_short+tree.hel.soil$ps1_short+tree.hel.soil$percc_short+tree.hel.soil$pomc_short+tree.hel.soil$cton_short)

tree.sel=ordiR2step(hel.rda.fulsoil.none,scope=formula(hel.rda.fulsoil.full),Pin=0.05,R2scope=TRUE)
tree.sel

##Just the variables forward selected
hel.rda.fulsoil = rda(tree.hel.soil[,8:155], tree.hel.soil[,c(168,181)])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared


###INVERT BY TREE DATA
dim(rdadate1)
hel.rda.fulsoil = rda(tree.hel.soil[,8:155],tree.hel.soil[,c(195:229)])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERTS BY PCMN
#to determine spatial autocorrelation
# First we perform PCNM to get the vectors
colnames(tree.hel.soil)
all.geog.dist=vegdist(tree.hel.soil[,193:194],method="euclid")
all.pcnm1=pcnm(all.geog.dist)
all.pcnmvecs=all.pcnm1$vectors
# If you can get the PCNM library to run, you could do the line below to select only significantly structured PCNMs
#tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs[,which(all.pcnm1$Moran_I[,2]<0.05)])
tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs)
names(tree.hel.all.pcnm)
# Now run step 1, global analysis
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:155], tree.hel.all.pcnm[,231:273])
anova(hel.rda.all.fulpcnm)
RsquareAdj(hel.rda.all.fulpcnm)
global.thresh=RsquareAdj(hel.rda.all.fulpcnm)$adj.r.squared
# now run step 2, the selection part

##INVERTS BY ECOSYSTEM
hel.rda.fulsoil = rda(rdadate1[,8:155]~rdadate1$Habitat)
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

#### Core plots ####
tree.hel.soil=rdadate2[rdadate2$EP=="Core",]
dim(tree.hel.soil)
rownames(tree.hel.soil)=tree.hel.soil[,1]
tree.hel.soil=na.exclude(tree.hel.soil)
# Here is the global analysis. Can proceed  Use adj. R square as additional stopping criterion.
colnames(tree.hel.soil)
dim(tree.hel.soil)

hel.rda.fulsoil = rda(tree.hel.soil[,8:155], tree.hel.soil[,165:189])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

##Forward selection
hel.rda.fulsoil.none = rda(tree.hel.soil[,8:155]~1)
hel.rda.fulsoil = rda(tree.hel.soil[,8:155], tree.hel.soil[,165:189])

hel.rda.fulsoil.full=rda(tree.hel.soil[,8:155]~tree.hel.soil$Ptot_long+tree.hel.soil$Po_long+tree.hel.soil$pH_long+tree.hel.soil$moist_long+tree.hel.soil$ps1_long+tree.hel.soil$ps2_long+tree.hel.soil$percc_long+tree.hel.soil$cton_long+tree.hel.soil$Ptot_nug+tree.hel.soil$Po_nug+tree.hel.soil$pH_nug+tree.hel.soil$moist_nug+tree.hel.soil$ps1_nug+tree.hel.soil$ps2_nug+tree.hel.soil$percc_nug+tree.hel.soil$pomc_nug+tree.hel.soil$cton_nug+tree.hel.soil$Ptot_short+tree.hel.soil$Po_short+tree.hel.soil$pH_short+tree.hel.soil$moist_short+tree.hel.soil$ps1_short+tree.hel.soil$percc_short+tree.hel.soil$pomc_short+tree.hel.soil$cton_short)

tree.sel=ordiR2step(hel.rda.fulsoil.none,scope=formula(hel.rda.fulsoil.full),Pin=0.05,R2scope=TRUE)
tree.sel

##Just the variables forward selected
hel.rda.fulsoil = rda(tree.hel.soil[,8:155], tree.hel.soil[,c(165)])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERT BY TREE DATA
dim(rdadate1)
hel.rda.fulsoil = rda(tree.hel.soil[,8:155],tree.hel.soil[,c(195:229)])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERTS BY PCMN
#to determine spatial autocorrelation
# First we perform PCNM to get the vectors
colnames(tree.hel.soil)
all.geog.dist=vegdist(tree.hel.soil[,193:194],method="euclid")
all.pcnm1=pcnm(all.geog.dist)
all.pcnmvecs=all.pcnm1$vectors
# If you can get the PCNM library to run, you could do the line below to select only significantly structured PCNMs
#tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs[,which(all.pcnm1$Moran_I[,2]<0.05)])
tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs)
names(tree.hel.all.pcnm)
# Now run step 1, global analysis
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:155], tree.hel.all.pcnm[,231:254])
anova(hel.rda.all.fulpcnm)
RsquareAdj(hel.rda.all.fulpcnm)
global.thresh=RsquareAdj(hel.rda.all.fulpcnm)$adj.r.squared

##INVERTS BY ECOSYSTEM
hel.rda.fulsoil = rda(tree.hel.soil[,8:155]~tree.hel.soil$Habitat)
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared


#### CORE+EDGE ####
tree.hel.soil=rdadate2[rdadate2$EP=="Core"|rdadate2$EP=="Edge",]
dim(tree.hel.soil)
rownames(tree.hel.soil)=tree.hel.soil[,1]
tree.hel.soil=na.exclude(tree.hel.soil)
# Here is the global analysis. Can proceed  Use adj. R square as additional stopping criterion.
colnames(tree.hel.soil)

hel.rda.fulsoil = rda(tree.hel.soil[,8:155], tree.hel.soil[,165:189])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

##Forward selection
hel.rda.fulsoil.none = rda(tree.hel.soil[,8:155]~1)
hel.rda.fulsoil = rda(tree.hel.soil[,8:155], tree.hel.soil[,165:189])

hel.rda.fulsoil.full=rda(tree.hel.soil[,8:155]~tree.hel.soil$Ptot_long+tree.hel.soil$Po_long+tree.hel.soil$pH_long+tree.hel.soil$moist_long+tree.hel.soil$ps1_long+tree.hel.soil$ps2_long+tree.hel.soil$percc_long+tree.hel.soil$cton_long+tree.hel.soil$Ptot_nug+tree.hel.soil$Po_nug+tree.hel.soil$pH_nug+tree.hel.soil$moist_nug+tree.hel.soil$ps1_nug+tree.hel.soil$ps2_nug+tree.hel.soil$percc_nug+tree.hel.soil$pomc_nug+tree.hel.soil$cton_nug+tree.hel.soil$Ptot_short+tree.hel.soil$Po_short+tree.hel.soil$pH_short+tree.hel.soil$moist_short+tree.hel.soil$ps1_short+tree.hel.soil$percc_short+tree.hel.soil$pomc_short+tree.hel.soil$cton_short)

tree.sel=ordiR2step(hel.rda.fulsoil.none,scope=formula(hel.rda.fulsoil.full),Pin=0.05,R2scope=TRUE)
tree.sel

##Just the variables forward selected
hel.rda.fulsoil = rda(tree.hel.soil[,8:155], tree.hel.soil[,c(168,173,179,166)])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERT BY TREE DATA
hel.rda.fulsoil = rda(tree.hel.soil[,8:155],tree.hel.soil[,c(195:229)])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

hel.rda.fulsoil.none = rda(tree.hel.soil[,8:155]~1)
hel.rda.fulsoil = rda(tree.hel.soil[,8:155], tree.hel.soil[,195:229])

hel.rda.fulsoil.full=rda(tree.hel.soil[,8:155]~tree.hel.soil$ACERUB+tree.hel.soil$ACESAC+tree.hel.soil$ACESIL+tree.hel.soil$BETALL+tree.hel.soil$CARCAR+tree.hel.soil$CARCOR+tree.hel.soil$CAROVA+tree.hel.soil$CARTOM+tree.hel.soil$CORFLO+tree.hel.soil$CRAPUN+tree.hel.soil$CORFLO+tree.hel.soil$FAGAME+tree.hel.soil$FRAAME+tree.hel.soil$FRANIG+tree.hel.soil$HAMVIR+tree.hel.soil$LIRTUP+tree.hel.soil$MAGACU+tree.hel.soil$MALCOR+tree.hel.soil$NYSSYL+tree.hel.soil$OSTVIR+tree.hel.soil$PLAOCC+tree.hel.soil$POPDEL+tree.hel.soil$POPGRA+tree.hel.soil$PRUSER+tree.hel.soil$QUEALB+tree.hel.soil$QUEBIC+tree.hel.soil$QUEPAL+tree.hel.soil$QUERUB+tree.hel.soil$SALNIG+tree.hel.soil$SASALB+tree.hel.soil$TILAME+tree.hel.soil$TOXVER+tree.hel.soil$ULMAME+tree.hel.soil$ULMRUB+tree.hel.soil$ULMSP+tree.hel.soil$VIBLEN)

tree.sel=ordiR2step(hel.rda.fulsoil.none,scope=formula(hel.rda.fulsoil.full),Pin=0.05,R2scope=TRUE)
tree.sel

##Just the variables forward selected
hel.rda.fulsoil = rda(tree.hel.soil[,8:155]~1)
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERTS BY PCMN
#to determine spatial autocorrelation
# First we perform PCNM to get the vectors
colnames(tree.hel.soil)
all.geog.dist=vegdist(tree.hel.soil[,193:194],method="euclid")
all.pcnm1=pcnm(all.geog.dist)
all.pcnmvecs=all.pcnm1$vectors
# If you can get the PCNM library to run, you could do the line below to select only significantly structured PCNMs
#tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs[,which(all.pcnm1$Moran_I[,2]<0.05)])
tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs)
names(tree.hel.all.pcnm)
# Now run step 1, global analysis
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:155], tree.hel.all.pcnm[,231:268])
anova(hel.rda.all.fulpcnm)
RsquareAdj(hel.rda.all.fulpcnm)
global.thresh=RsquareAdj(hel.rda.all.fulpcnm)$adj.r.squared
# now run step 2, the selection part

##INVERTS BY ECOSYSTEM
hel.rda.fulsoil = rda(rdadate1[,8:155]~rdadate1$Habitat)
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

## Variance partitioning
varpart(tree.hel.all.pcnm[,8:155], tree.hel.all.pcnm[,c(168,173,179,166)], tree.hel.all.pcnm[,c(195:229)])
## Check to see if it's significant when PCNM and soil come first.
hel.rda.all.partpcnm=rda(tree.hel.all.pcnm[,8:155], tree.hel.all.pcnm[,c(168,173,179,166)], tree.hel.all.pcnm[,c(195:229)])
anova(hel.rda.all.partpcnm)
# Yes.
hel.rda.all.partsoil=rda(tree.hel.all.pcnm[,8:155], tree.hel.all.pcnm[,c(195:229)], tree.hel.all.pcnm[,c(168,173,179,166)])
anova(hel.rda.all.partsoil)
```
```{r RDA DATE3}
## Remove fruitflies from the analyses
rdadate3=commdata[commdata$Date=="8.10.16",which(colnames(commdata)!="Drosophilidae..Drosophila"&colnames(commdata)!="Drosophilidae..Microdrosophila"&colnames(commdata)!="Drosophilidae..Mycodrosophila")]
dim(rdadate3)

#### All plots
tree.hel.soil=rdadate3
dim(tree.hel.soil)
rownames(tree.hel.soil)=tree.hel.soil[,1]
tree.hel.soil=na.exclude(tree.hel.soil)
# Here is the global analysis. Can proceed  Use adj. R square as additional stopping criterion.
colnames(tree.hel.soil)
dim(tree.hel.soil)

hel.rda.fulsoil = rda(tree.hel.soil[,8:155], tree.hel.soil[,165:189])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

##Forward selection
hel.rda.fulsoil.none = rda(tree.hel.soil[,8:155]~1)
hel.rda.fulsoil = rda(tree.hel.soil[,8:155], tree.hel.soil[,165:189])

hel.rda.fulsoil.full=rda(tree.hel.soil[,8:155]~tree.hel.soil$Ptot_long+tree.hel.soil$Po_long+tree.hel.soil$pH_long+tree.hel.soil$moist_long+tree.hel.soil$ps1_long+tree.hel.soil$ps2_long+tree.hel.soil$percc_long+tree.hel.soil$cton_long+tree.hel.soil$Ptot_nug+tree.hel.soil$Po_nug+tree.hel.soil$pH_nug+tree.hel.soil$moist_nug+tree.hel.soil$ps1_nug+tree.hel.soil$ps2_nug+tree.hel.soil$percc_nug+tree.hel.soil$pomc_nug+tree.hel.soil$cton_nug+tree.hel.soil$Ptot_short+tree.hel.soil$Po_short+tree.hel.soil$pH_short+tree.hel.soil$moist_short+tree.hel.soil$ps1_short+tree.hel.soil$percc_short+tree.hel.soil$pomc_short+tree.hel.soil$cton_short)

tree.sel=ordiR2step(hel.rda.fulsoil.none,scope=formula(hel.rda.fulsoil.full),Pin=0.05,R2scope=TRUE)
tree.sel

##Just the variables forward selected
hel.rda.fulsoil = rda(tree.hel.soil[,8:155], tree.hel.soil[,c(165,178,180,175)])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared


###INVERT BY TREE DATA
dim(rdadate3)
hel.rda.fulsoil = rda(tree.hel.soil[,8:155],tree.hel.soil[,c(195:229)])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERTS BY PCMN
#to determine spatial autocorrelation
# First we perform PCNM to get the vectors
colnames(tree.hel.soil)
all.geog.dist=vegdist(tree.hel.soil[,193:194],method="euclid")
all.pcnm1=pcnm(all.geog.dist)
all.pcnmvecs=all.pcnm1$vectors
# If you can get the PCNM library to run, you could do the line below to select only significantly structured PCNMs
#tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs[,which(all.pcnm1$Moran_I[,2]<0.05)])
tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs)
names(tree.hel.all.pcnm)
# Now run step 1, global analysis
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:155], tree.hel.all.pcnm[,231:274])
anova(hel.rda.all.fulpcnm)
RsquareAdj(hel.rda.all.fulpcnm)
global.thresh=RsquareAdj(hel.rda.all.fulpcnm)$adj.r.squared
# now run step 2, the selection part

#forward selection for our PCNM variables
hel.rda.all.pcnm.none=rda(tree.hel.all.pcnm[,8:155]~1)
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:155], tree.hel.all.pcnm[,231:274])

hel.rda.all.pcnm.full=rda(tree.hel.all.pcnm[,8:155]~tree.hel.all.pcnm$PCNM1+tree.hel.all.pcnm$PCNM2+tree.hel.all.pcnm$PCNM3+tree.hel.all.pcnm$PCNM4+tree.hel.all.pcnm$PCNM5+tree.hel.all.pcnm$PCNM6+tree.hel.all.pcnm$PCNM7+tree.hel.all.pcnm$PCNM8+tree.hel.all.pcnm$PCNM9+tree.hel.all.pcnm$PCNM10+tree.hel.all.pcnm$PCNM11+tree.hel.all.pcnm$PCNM12+tree.hel.all.pcnm$PCNM13+tree.hel.all.pcnm$PCNM14+tree.hel.all.pcnm$PCNM15+tree.hel.all.pcnm$PCNM16+tree.hel.all.pcnm$PCNM17+tree.hel.all.pcnm$PCNM18+tree.hel.all.pcnm$PCNM19+tree.hel.all.pcnm$PCNM20+tree.hel.all.pcnm$PCNM21+tree.hel.all.pcnm$PCNM22+tree.hel.all.pcnm$PCNM23+tree.hel.all.pcnm$PCNM24+tree.hel.all.pcnm$PCNM25+tree.hel.all.pcnm$PCNM26+tree.hel.all.pcnm$PCNM27+tree.hel.all.pcnm$PCNM28+tree.hel.all.pcnm$PCNM29+tree.hel.all.pcnm$PCNM30+tree.hel.all.pcnm$PCNM31+tree.hel.all.pcnm$PCNM32+tree.hel.all.pcnm$PCNM33+tree.hel.all.pcnm$PCNM34+tree.hel.all.pcnm$PCNM35+tree.hel.all.pcnm$PCNM36+tree.hel.all.pcnm$PCNM37+tree.hel.all.pcnm$PCNM38+tree.hel.all.pcnm$PCNM39+tree.hel.all.pcnm$PCNM40+tree.hel.all.pcnm$PCNM41+tree.hel.all.pcnm$PCNM42+tree.hel.all.pcnm$PCNM43+tree.hel.all.pcnm$PCNM44)

tree.sel=ordiR2step(hel.rda.all.pcnm.none,scope=formula(hel.rda.all.pcnm.full),Pin=0.05,R2scope=TRUE)
tree.sel

##Just the variables forward selected
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:155], tree.hel.all.pcnm[,c(267:268,231:232,236,239)])
anova(hel.rda.all.fulpcnm)
RsquareAdj(hel.rda.all.fulpcnm)
global.thresh=RsquareAdj(hel.rda.all.fulpcnm)$adj.r.squared

## Variance partitioning
varpart(tree.hel.all.pcnm[,8:155], tree.hel.all.pcnm[,c(165,178,180,175)], tree.hel.all.pcnm[,c(267:268,231:232,236,239)])
## Check to see if it's significant when PCNM and soil come first.
hel.rda.all.partpcnm=rda(tree.hel.all.pcnm[,8:155], tree.hel.all.pcnm[,c(165,178,180,175)], tree.hel.all.pcnm[,c(267:268,231:232,236,239)])
anova(hel.rda.all.partpcnm)
# Yes.
hel.rda.all.partsoil=rda(tree.hel.all.pcnm[,8:155], tree.hel.all.pcnm[,c(267:268,231:232,236,239)], tree.hel.all.pcnm[,c(165,178,180,175)])
anova(hel.rda.all.partsoil)


##INVERTS BY ECOSYSTEM
hel.rda.fulsoil = rda(rdadate1[,8:155]~rdadate1$Habitat)
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

#### Core plots ####
tree.hel.soil=rdadate3[rdadate3$EP=="Core",]
dim(tree.hel.soil)
rownames(tree.hel.soil)=tree.hel.soil[,1]
tree.hel.soil=na.exclude(tree.hel.soil)
# Here is the global analysis. Can proceed  Use adj. R square as additional stopping criterion.
colnames(tree.hel.soil)
dim(tree.hel.soil)

hel.rda.fulsoil = rda(tree.hel.soil[,8:155], tree.hel.soil[,165:189])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERT BY TREE DATA
dim(rdadate3)
hel.rda.fulsoil = rda(tree.hel.soil[,8:155],tree.hel.soil[,c(195:229)])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERTS BY PCMN
#to determine spatial autocorrelation
# First we perform PCNM to get the vectors
colnames(tree.hel.soil)
all.geog.dist=vegdist(tree.hel.soil[,193:194],method="euclid")
all.pcnm1=pcnm(all.geog.dist)
all.pcnmvecs=all.pcnm1$vectors
# If you can get the PCNM library to run, you could do the line below to select only significantly structured PCNMs
#tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs[,which(all.pcnm1$Moran_I[,2]<0.05)])
tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs)
names(tree.hel.all.pcnm)
# Now run step 1, global analysis
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:155], tree.hel.all.pcnm[,231:255])
anova(hel.rda.all.fulpcnm)
RsquareAdj(hel.rda.all.fulpcnm)
global.thresh=RsquareAdj(hel.rda.all.fulpcnm)$adj.r.squared

#forward selection for our PCNM variables
hel.rda.all.pcnm.none=rda(tree.hel.all.pcnm[,8:155]~1)
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:155], tree.hel.all.pcnm[,231:255])

hel.rda.all.pcnm.full=rda(tree.hel.all.pcnm[,8:155]~tree.hel.all.pcnm$PCNM1+tree.hel.all.pcnm$PCNM2+tree.hel.all.pcnm$PCNM3+tree.hel.all.pcnm$PCNM4+tree.hel.all.pcnm$PCNM5+tree.hel.all.pcnm$PCNM6+tree.hel.all.pcnm$PCNM7+tree.hel.all.pcnm$PCNM8+tree.hel.all.pcnm$PCNM9+tree.hel.all.pcnm$PCNM10+tree.hel.all.pcnm$PCNM11+tree.hel.all.pcnm$PCNM12+tree.hel.all.pcnm$PCNM13+tree.hel.all.pcnm$PCNM14+tree.hel.all.pcnm$PCNM15+tree.hel.all.pcnm$PCNM16+tree.hel.all.pcnm$PCNM17+tree.hel.all.pcnm$PCNM18+tree.hel.all.pcnm$PCNM19+tree.hel.all.pcnm$PCNM20+tree.hel.all.pcnm$PCNM21+tree.hel.all.pcnm$PCNM22+tree.hel.all.pcnm$PCNM23+tree.hel.all.pcnm$PCNM24+tree.hel.all.pcnm$PCNM25)

tree.sel=ordiR2step(hel.rda.all.pcnm.none,scope=formula(hel.rda.all.pcnm.full),Pin=0.05,R2scope=TRUE)
tree.sel

##Just the variables forward selected
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:155], tree.hel.all.pcnm[,c(231:235,245,248:250,253)])
anova(hel.rda.all.fulpcnm)
RsquareAdj(hel.rda.all.fulpcnm)
global.thresh=RsquareAdj(hel.rda.all.fulpcnm)$adj.r.squared


##INVERTS BY ECOSYSTEM
hel.rda.fulsoil = rda(tree.hel.soil[,8:155]~tree.hel.soil$Habitat)
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared


#### CORE+EDGE ####
tree.hel.soil=rdadate3[rdadate3$EP=="Core"|rdadate3$EP=="Edge",]
dim(tree.hel.soil)
rownames(tree.hel.soil)=tree.hel.soil[,1]
tree.hel.soil=na.exclude(tree.hel.soil)
# Here is the global analysis. Can proceed  Use adj. R square as additional stopping criterion.
colnames(tree.hel.soil)

hel.rda.fulsoil = rda(tree.hel.soil[,8:155], tree.hel.soil[,165:189])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERT BY TREE DATA
hel.rda.fulsoil = rda(tree.hel.soil[,8:155],tree.hel.soil[,c(195:229)])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERTS BY PCMN
#to determine spatial autocorrelation
# First we perform PCNM to get the vectors
colnames(tree.hel.soil)
all.geog.dist=vegdist(tree.hel.soil[,193:194],method="euclid")
all.pcnm1=pcnm(all.geog.dist)
all.pcnmvecs=all.pcnm1$vectors
# If you can get the PCNM library to run, you could do the line below to select only significantly structured PCNMs
#tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs[,which(all.pcnm1$Moran_I[,2]<0.05)])
tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs)
names(tree.hel.all.pcnm)
# Now run step 1, global analysis
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:155], tree.hel.all.pcnm[,231:268])
anova(hel.rda.all.fulpcnm)
RsquareAdj(hel.rda.all.fulpcnm)
global.thresh=RsquareAdj(hel.rda.all.fulpcnm)$adj.r.squared
# now run step 2, the selection part

##INVERTS BY ECOSYSTEM
hel.rda.fulsoil = rda(rdadate1[,8:155]~rdadate1$Habitat)
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared
```
```{r RDA DATE4}
## Remove fruitflies from the analyses
rdadate4=commdata[commdata$Date=="10.15.16",which(colnames(commdata)!="Drosophilidae..Drosophila"&colnames(commdata)!="Drosophilidae..Microdrosophila"&colnames(commdata)!="Drosophilidae..Mycodrosophila")]
dim(rdadate4)

#### All plots
tree.hel.soil=rdadate4
dim(tree.hel.soil)
rownames(tree.hel.soil)=tree.hel.soil[,1]
tree.hel.soil=na.exclude(tree.hel.soil)
# Here is the global analysis. Can proceed  Use adj. R square as additional stopping criterion.
colnames(tree.hel.soil)
dim(tree.hel.soil)

hel.rda.fulsoil = rda(tree.hel.soil[,8:155], tree.hel.soil[,165:189])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

##Forward selection
hel.rda.fulsoil.none = rda(tree.hel.soil[,8:155]~1)
hel.rda.fulsoil = rda(tree.hel.soil[,8:155], tree.hel.soil[,165:189])

hel.rda.fulsoil.full=rda(tree.hel.soil[,8:155]~tree.hel.soil$Ptot_long+tree.hel.soil$Po_long+tree.hel.soil$pH_long+tree.hel.soil$moist_long+tree.hel.soil$ps1_long+tree.hel.soil$ps2_long+tree.hel.soil$percc_long+tree.hel.soil$cton_long+tree.hel.soil$Ptot_nug+tree.hel.soil$Po_nug+tree.hel.soil$pH_nug+tree.hel.soil$moist_nug+tree.hel.soil$ps1_nug+tree.hel.soil$ps2_nug+tree.hel.soil$percc_nug+tree.hel.soil$pomc_nug+tree.hel.soil$cton_nug+tree.hel.soil$Ptot_short+tree.hel.soil$Po_short+tree.hel.soil$pH_short+tree.hel.soil$moist_short+tree.hel.soil$ps1_short+tree.hel.soil$percc_short+tree.hel.soil$pomc_short+tree.hel.soil$cton_short)

tree.sel=ordiR2step(hel.rda.fulsoil.none,scope=formula(hel.rda.fulsoil.full),Pin=0.05,R2scope=TRUE)
tree.sel

##Just the variables forward selected
hel.rda.fulsoil = rda(tree.hel.soil[,8:155], tree.hel.soil[,c(169,172,173,182,174)])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared


###INVERT BY TREE DATA
dim(rdadate4)
hel.rda.fulsoil = rda(tree.hel.soil[,8:155],tree.hel.soil[,c(195:229)])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERTS BY PCMN
#to determine spatial autocorrelation
# First we perform PCNM to get the vectors
colnames(tree.hel.soil)
all.geog.dist=vegdist(tree.hel.soil[,193:194],method="euclid")
all.pcnm1=pcnm(all.geog.dist)
all.pcnmvecs=all.pcnm1$vectors
# If you can get the PCNM library to run, you could do the line below to select only significantly structured PCNMs
#tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs[,which(all.pcnm1$Moran_I[,2]<0.05)])
tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs)
names(tree.hel.all.pcnm)
# Now run step 1, global analysis
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:155], tree.hel.all.pcnm[,231:271])
anova(hel.rda.all.fulpcnm)
RsquareAdj(hel.rda.all.fulpcnm)
global.thresh=RsquareAdj(hel.rda.all.fulpcnm)$adj.r.squared
# now run step 2, the selection part

##INVERTS BY ECOSYSTEM
hel.rda.fulsoil = rda(rdadate1[,8:155]~rdadate1$Habitat)
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

#### Core plots ####
tree.hel.soil=rdadate4[rdadate4$EP=="Core",]
dim(tree.hel.soil)
rownames(tree.hel.soil)=tree.hel.soil[,1]
tree.hel.soil=na.exclude(tree.hel.soil)
# Here is the global analysis. Can proceed  Use adj. R square as additional stopping criterion.
colnames(tree.hel.soil)
dim(tree.hel.soil)

hel.rda.fulsoil = rda(tree.hel.soil[,8:155], tree.hel.soil[,165:189])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERT BY TREE DATA
dim(rdadate4)
hel.rda.fulsoil = rda(tree.hel.soil[,8:155],tree.hel.soil[,c(195:229)])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERTS BY PCMN
#to determine spatial autocorrelation
# First we perform PCNM to get the vectors
colnames(tree.hel.soil)
all.geog.dist=vegdist(tree.hel.soil[,193:194],method="euclid")
all.pcnm1=pcnm(all.geog.dist)
all.pcnmvecs=all.pcnm1$vectors
# If you can get the PCNM library to run, you could do the line below to select only significantly structured PCNMs
#tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs[,which(all.pcnm1$Moran_I[,2]<0.05)])
tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs)
names(tree.hel.all.pcnm)
# Now run step 1, global analysis
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:155], tree.hel.all.pcnm[,231:255])
anova(hel.rda.all.fulpcnm)
RsquareAdj(hel.rda.all.fulpcnm)
global.thresh=RsquareAdj(hel.rda.all.fulpcnm)$adj.r.squared

##INVERTS BY ECOSYSTEM
hel.rda.fulsoil = rda(tree.hel.soil[,8:155]~tree.hel.soil$Habitat)
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared


#### CORE+EDGE ####
tree.hel.soil=rdadate4[rdadate4$EP=="Core"|rdadate4$EP=="Edge",]
dim(tree.hel.soil)
rownames(tree.hel.soil)=tree.hel.soil[,1]
tree.hel.soil=na.exclude(tree.hel.soil)
# Here is the global analysis. Can proceed  Use adj. R square as additional stopping criterion.
colnames(tree.hel.soil)

hel.rda.fulsoil = rda(tree.hel.soil[,8:155], tree.hel.soil[,165:189])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

##Forward selection
hel.rda.fulsoil.none = rda(tree.hel.soil[,8:155]~1)
hel.rda.fulsoil = rda(tree.hel.soil[,8:155], tree.hel.soil[,165:189])

hel.rda.fulsoil.full=rda(tree.hel.soil[,8:155]~tree.hel.soil$Ptot_long+tree.hel.soil$Po_long+tree.hel.soil$pH_long+tree.hel.soil$moist_long+tree.hel.soil$ps1_long+tree.hel.soil$ps2_long+tree.hel.soil$percc_long+tree.hel.soil$cton_long+tree.hel.soil$Ptot_nug+tree.hel.soil$Po_nug+tree.hel.soil$pH_nug+tree.hel.soil$moist_nug+tree.hel.soil$ps1_nug+tree.hel.soil$ps2_nug+tree.hel.soil$percc_nug+tree.hel.soil$pomc_nug+tree.hel.soil$cton_nug+tree.hel.soil$Ptot_short+tree.hel.soil$Po_short+tree.hel.soil$pH_short+tree.hel.soil$moist_short+tree.hel.soil$ps1_short+tree.hel.soil$percc_short+tree.hel.soil$pomc_short+tree.hel.soil$cton_short)

tree.sel=ordiR2step(hel.rda.fulsoil.none,scope=formula(hel.rda.fulsoil.full),Pin=0.05,R2scope=TRUE)
tree.sel

##Just the variables forward selected
hel.rda.fulsoil = rda(tree.hel.soil[,8:155], tree.hel.soil[,c(169,172,173)])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERT BY TREE DATA
hel.rda.fulsoil = rda(tree.hel.soil[,8:155],tree.hel.soil[,c(195:229)])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERTS BY PCMN
#to determine spatial autocorrelation
# First we perform PCNM to get the vectors
colnames(tree.hel.soil)
all.geog.dist=vegdist(tree.hel.soil[,193:194],method="euclid")
all.pcnm1=pcnm(all.geog.dist)
all.pcnmvecs=all.pcnm1$vectors
# If you can get the PCNM library to run, you could do the line below to select only significantly structured PCNMs
#tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs[,which(all.pcnm1$Moran_I[,2]<0.05)])
tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs)
names(tree.hel.all.pcnm)
# Now run step 1, global analysis
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:155], tree.hel.all.pcnm[,231:266])
anova(hel.rda.all.fulpcnm)
RsquareAdj(hel.rda.all.fulpcnm)
global.thresh=RsquareAdj(hel.rda.all.fulpcnm)$adj.r.squared
# now run step 2, the selection part

##INVERTS BY ECOSYSTEM
hel.rda.fulsoil = rda(rdadate1[,8:155]~rdadate1$Habitat)
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared
```

```{r CCA}
## Date 1
##Let's take out the TerrTypes that we don't test (like things that include D and thus don't have replicates)
date1.cca=date1[date1$TerrType=="B"|date1$TerrType=="RU"|date1$TerrType=="U"|date1$TerrType=="BU"|date1$TerrType=="UR"|date1$TerrType=="T-UR"|date1$TerrType=="UB"|date1$TerrType=="T-UB"|date1$TerrType=="R"|date1$TerrType=="RB"|date1$TerrType=="BR"|date1$TerrType=="T-RB",]
## the CCA
fly.cca.d1=cca(date1.cca[,8:155]~date1.cca$TerrType)
anova(fly.cca.d1)
plot(fly.cca.d1)

## Date 2
date2.cca=date2[date2$TerrType=="B"|date2$TerrType=="RU"|date2$TerrType=="U"|date2$TerrType=="BU"|date2$TerrType=="UR"|date2$TerrType=="T-UR"|date2$TerrType=="UB"|date2$TerrType=="T-UB"|date2$TerrType=="R"|date2$TerrType=="RB"|date2$TerrType=="BR"|date2$TerrType=="T-RB",]

fly.cca.d2=cca(date2.cca[,8:155]~date2.cca$TerrType)
anova(fly.cca.d2)
plot(fly.cca.d2)

## Date 3
date3.cca=date3[date3$TerrType=="B"|date3$TerrType=="RU"|date3$TerrType=="U"|date3$TerrType=="BU"|date3$TerrType=="UR"|date3$TerrType=="T-UR"|date3$TerrType=="UB"|date3$TerrType=="T-UB"|date3$TerrType=="R"|date3$TerrType=="RB"|date3$TerrType=="BR"|date3$TerrType=="T-RB",]

fly.cca.d3=cca(date3.cca[,8:155]~date3.cca$TerrType)
anova(fly.cca.d3)
plot(fly.cca.d3)

## Date 4
date4.cca=date4[date4$TerrType=="B"|date4$TerrType=="RU"|date4$TerrType=="U"|date4$TerrType=="BU"|date4$TerrType=="UR"|date4$TerrType=="T-UR"|date4$TerrType=="UB"|date4$TerrType=="T-UB"|date4$TerrType=="R"|date4$TerrType=="RB"|date4$TerrType=="BR"|date4$TerrType=="T-RB",]
fly.cca.d4=cca(date4.cca[,8:155]~date4.cca$TerrType)
anova(fly.cca.d4)
plot(fly.cca.d4)
```

```{r Functional Feeding Groups DATE1}
### USING THE CODE FOR SPLITTING TAXONOMIC GROUPS. data.agg will ONLY fit what we specify in the other code. NOTES CAN BE FOUND AT THE END OF THE CODE FOR EACH GROUP

#### All plots
tree.hel.soil=merge(date1.agg,soildata,by="Plot")
tree.hel.soil=merge(tree.hel.soil, tree.hel, by="Plot")

rownames(tree.hel.soil)=tree.hel.soil[,1]
tree.hel.soil=na.exclude(tree.hel.soil)
# Here is the global analysis. Can proceed  Use adj. R square as additional stopping criterion.
colnames(tree.hel.soil)
dim(tree.hel.soil)

hel.rda.fulsoil = rda(tree.hel.soil[,8:27], tree.hel.soil[,37:61])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERT BY TREE DATA
hel.rda.fulsoil = rda(tree.hel.soil[,8:27],tree.hel.soil[,c(70:104)])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERTS BY PCMN
#to determine spatial autocorrelation
# First we perform PCNM to get the vectors
colnames(tree.hel.soil)
all.geog.dist=vegdist(tree.hel.soil[,68:69],method="euclid")
all.pcnm1=pcnm(all.geog.dist)
all.pcnmvecs=all.pcnm1$vectors
# If you can get the PCNM library to run, you could do the line below to select only significantly structured PCNMs
#tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs[,which(all.pcnm1$Moran_I[,2]<0.05)])
tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs)
names(tree.hel.all.pcnm)
# Now run step 1, global analysis
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:27], tree.hel.all.pcnm[,106:143])
anova(hel.rda.all.fulpcnm)
RsquareAdj(hel.rda.all.fulpcnm)
global.thresh=RsquareAdj(hel.rda.all.fulpcnm)$adj.r.squared
# now run step 2, the selection part

#forward selection for our PCNM variables
hel.rda.all.pcnm.none=rda(tree.hel.all.pcnm[,8:27]~1)
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:27], tree.hel.all.pcnm[,95:132])

hel.rda.all.pcnm.full=rda(tree.hel.all.pcnm[,8:27]~tree.hel.all.pcnm$PCNM1+tree.hel.all.pcnm$PCNM2+tree.hel.all.pcnm$PCNM3+tree.hel.all.pcnm$PCNM4+tree.hel.all.pcnm$PCNM5+tree.hel.all.pcnm$PCNM6+tree.hel.all.pcnm$PCNM7+tree.hel.all.pcnm$PCNM8+tree.hel.all.pcnm$PCNM9+tree.hel.all.pcnm$PCNM10+tree.hel.all.pcnm$PCNM11+tree.hel.all.pcnm$PCNM12+tree.hel.all.pcnm$PCNM13+tree.hel.all.pcnm$PCNM14+tree.hel.all.pcnm$PCNM15+tree.hel.all.pcnm$PCNM16+tree.hel.all.pcnm$PCNM17+tree.hel.all.pcnm$PCNM18+tree.hel.all.pcnm$PCNM19+tree.hel.all.pcnm$PCNM20+tree.hel.all.pcnm$PCNM21+tree.hel.all.pcnm$PCNM22+tree.hel.all.pcnm$PCNM23+tree.hel.all.pcnm$PCNM24+tree.hel.all.pcnm$PCNM25+tree.hel.all.pcnm$PCNM26+tree.hel.all.pcnm$PCNM27+tree.hel.all.pcnm$PCNM28+tree.hel.all.pcnm$PCNM29+tree.hel.all.pcnm$PCNM30+tree.hel.all.pcnm$PCNM31+tree.hel.all.pcnm$PCNM32+tree.hel.all.pcnm$PCNM33+tree.hel.all.pcnm$PCNM34+tree.hel.all.pcnm$PCNM35+tree.hel.all.pcnm$PCNM36+tree.hel.all.pcnm$PCNM37+tree.hel.all.pcnm$PCNM38)

tree.sel=ordiR2step(hel.rda.all.pcnm.none,scope=formula(hel.rda.all.pcnm.full),Pin=0.05,R2scope=TRUE)
tree.sel

##Just the variables forward selected
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:27], tree.hel.all.pcnm[,c(96,125,102,98,107)])
anova(hel.rda.all.fulpcnm)
RsquareAdj(hel.rda.all.fulpcnm)
global.thresh=RsquareAdj(hel.rda.all.fulpcnm)$adj.r.squared

##INVERTS BY ECOSYSTEM
hel.rda.fulsoil = rda(tree.hel.soil[,8:27]~tree.hel.soil$Habitat)
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

#### CORE+EDGE ####
tree.hel.soil=tree.hel.soil[tree.hel.soil$EP.x=="Core"|tree.hel.soil$EP.x=="Edge",]
dim(tree.hel.soil)
rownames(tree.hel.soil)=tree.hel.soil[,1]
tree.hel.soil=na.exclude(tree.hel.soil)
# Here is the global analysis. Can proceed  Use adj. R square as additional stopping criterion.
colnames(tree.hel.soil)

hel.rda.fulsoil = rda(tree.hel.soil[,8:27], tree.hel.soil[,37:61])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERT BY TREE DATA
hel.rda.fulsoil = rda(tree.hel.soil[,8:27],tree.hel.soil[,c(70:104)])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERTS BY PCMN
#to determine spatial autocorrelation
# First we perform PCNM to get the vectors
colnames(tree.hel.soil)
all.geog.dist=vegdist(tree.hel.soil[,68:69],method="euclid")
all.pcnm1=pcnm(all.geog.dist)
all.pcnmvecs=all.pcnm1$vectors
# If you can get the PCNM library to run, you could do the line below to select only significantly structured PCNMs
#tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs[,which(all.pcnm1$Moran_I[,2]<0.05)])
tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs)
names(tree.hel.all.pcnm)
# Now run step 1, global analysis
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:27], tree.hel.all.pcnm[,106:137])
anova(hel.rda.all.fulpcnm)
RsquareAdj(hel.rda.all.fulpcnm)
global.thresh=RsquareAdj(hel.rda.all.fulpcnm)$adj.r.squared

#forward selection for our PCNM variables
hel.rda.all.pcnm.none=rda(tree.hel.all.pcnm[,8:27]~1)
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:27], tree.hel.all.pcnm[,95:126])

hel.rda.all.pcnm.full=rda(tree.hel.all.pcnm[,8:27]~tree.hel.all.pcnm$PCNM1+tree.hel.all.pcnm$PCNM2+tree.hel.all.pcnm$PCNM3+tree.hel.all.pcnm$PCNM4+tree.hel.all.pcnm$PCNM5+tree.hel.all.pcnm$PCNM6+tree.hel.all.pcnm$PCNM7+tree.hel.all.pcnm$PCNM8+tree.hel.all.pcnm$PCNM9+tree.hel.all.pcnm$PCNM10+tree.hel.all.pcnm$PCNM11+tree.hel.all.pcnm$PCNM12+tree.hel.all.pcnm$PCNM13+tree.hel.all.pcnm$PCNM14+tree.hel.all.pcnm$PCNM15+tree.hel.all.pcnm$PCNM16+tree.hel.all.pcnm$PCNM17+tree.hel.all.pcnm$PCNM18+tree.hel.all.pcnm$PCNM19+tree.hel.all.pcnm$PCNM20+tree.hel.all.pcnm$PCNM21+tree.hel.all.pcnm$PCNM22+tree.hel.all.pcnm$PCNM23+tree.hel.all.pcnm$PCNM24+tree.hel.all.pcnm$PCNM25+tree.hel.all.pcnm$PCNM26+tree.hel.all.pcnm$PCNM27+tree.hel.all.pcnm$PCNM28+tree.hel.all.pcnm$PCNM29+tree.hel.all.pcnm$PCNM30+tree.hel.all.pcnm$PCNM31+tree.hel.all.pcnm$PCNM32)

tree.sel=ordiR2step(hel.rda.all.pcnm.none,scope=formula(hel.rda.all.pcnm.full),Pin=0.05,R2scope=TRUE)
tree.sel

##Just the variables forward selected
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:27], tree.hel.all.pcnm[,c(96:97,102,122)])
anova(hel.rda.all.fulpcnm)
RsquareAdj(hel.rda.all.fulpcnm)
global.thresh=RsquareAdj(hel.rda.all.fulpcnm)$adj.r.squared

##INVERTS BY ECOSYSTEM
hel.rda.fulsoil = rda(tree.hel.soil[,8:27]~tree.hel.soil$Habitat)
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

#### Core plots ####
tree.hel.soil=tree.hel.soil[tree.hel.soil$EP.x=="Core",]
dim(tree.hel.soil)
rownames(tree.hel.soil)=tree.hel.soil[,1]
tree.hel.soil=na.exclude(tree.hel.soil)
# Here is the global analysis. Can proceed  Use adj. R square as additional stopping criterion.
colnames(tree.hel.soil)
dim(tree.hel.soil)

hel.rda.fulsoil = rda(tree.hel.soil[,8:27], tree.hel.soil[,37:61])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERT BY TREE DATA
hel.rda.fulsoil = rda(tree.hel.soil[,8:27],tree.hel.soil[,c(70:104)])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERTS BY PCMN
#to determine spatial autocorrelation
# First we perform PCNM to get the vectors
colnames(tree.hel.soil)
all.geog.dist=vegdist(tree.hel.soil[,68:69],method="euclid")
all.pcnm1=pcnm(all.geog.dist)
all.pcnmvecs=all.pcnm1$vectors
# If you can get the PCNM library to run, you could do the line below to select only significantly structured PCNMs
#tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs[,which(all.pcnm1$Moran_I[,2]<0.05)])
tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs)
names(tree.hel.all.pcnm)
# Now run step 1, global analysis
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:27], tree.hel.all.pcnm[,106:124])
anova(hel.rda.all.fulpcnm)
RsquareAdj(hel.rda.all.fulpcnm)
global.thresh=RsquareAdj(hel.rda.all.fulpcnm)$adj.r.squared
# now run step 2, the selection part

#forward selection for our PCNM variables
hel.rda.all.pcnm.none=rda(tree.hel.all.pcnm[,8:27]~1)
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:27], tree.hel.all.pcnm[,95:113])

hel.rda.all.pcnm.full=rda(tree.hel.all.pcnm[,8:27]~tree.hel.all.pcnm$PCNM1+tree.hel.all.pcnm$PCNM2+tree.hel.all.pcnm$PCNM3+tree.hel.all.pcnm$PCNM4+tree.hel.all.pcnm$PCNM5+tree.hel.all.pcnm$PCNM6+tree.hel.all.pcnm$PCNM7+tree.hel.all.pcnm$PCNM8+tree.hel.all.pcnm$PCNM9+tree.hel.all.pcnm$PCNM10+tree.hel.all.pcnm$PCNM11+tree.hel.all.pcnm$PCNM12+tree.hel.all.pcnm$PCNM13+tree.hel.all.pcnm$PCNM14+tree.hel.all.pcnm$PCNM15+tree.hel.all.pcnm$PCNM16+tree.hel.all.pcnm$PCNM17+tree.hel.all.pcnm$PCNM18+tree.hel.all.pcnm$PCNM19)

tree.sel=ordiR2step(hel.rda.all.pcnm.none,scope=formula(hel.rda.all.pcnm.full),Pin=0.05,R2scope=TRUE)
tree.sel

##Just the variables forward selected
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:27], tree.hel.all.pcnm[,c(113,95,98,111,97,100,103,96)])
anova(hel.rda.all.fulpcnm)
RsquareAdj(hel.rda.all.fulpcnm)
global.thresh=RsquareAdj(hel.rda.all.fulpcnm)$adj.r.squared

##INVERTS BY ECOSYSTEM
hel.rda.fulsoil = rda(tree.hel.soil[,8:27]~tree.hel.soil$Habitat)
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared
```
```{r Functional Feeding Groups DATE2}
### USING THE CODE FOR SPLITTING TAXONOMIC GROUPS. data.agg will ONLY fit what we specify in the other code. NOTES CAN BE FOUND AT THE END OF THE CODE FOR EACH GROUP

#### All plots
tree.hel.soil=merge(date2.agg,soildata,by="Plot")
tree.hel.soil=merge(tree.hel.soil, tree.hel, by="Plot")

rownames(tree.hel.soil)=tree.hel.soil[,1]
tree.hel.soil=na.exclude(tree.hel.soil)
# Here is the global analysis. Can proceed  Use adj. R square as additional stopping criterion.
colnames(tree.hel.soil)
dim(tree.hel.soil)

hel.rda.fulsoil = rda(tree.hel.soil[,8:27], tree.hel.soil[,37:61])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERT BY TREE DATA
hel.rda.fulsoil = rda(tree.hel.soil[,8:27],tree.hel.soil[,c(70:104)])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERTS BY PCMN
#to determine spatial autocorrelation
# First we perform PCNM to get the vectors
colnames(tree.hel.soil)
all.geog.dist=vegdist(tree.hel.soil[,68:69],method="euclid")
all.pcnm1=pcnm(all.geog.dist)
all.pcnmvecs=all.pcnm1$vectors
# If you can get the PCNM library to run, you could do the line below to select only significantly structured PCNMs
#tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs[,which(all.pcnm1$Moran_I[,2]<0.05)])
tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs)
names(tree.hel.all.pcnm)
# Now run step 1, global analysis
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:27], tree.hel.all.pcnm[,106:143])
anova(hel.rda.all.fulpcnm)
RsquareAdj(hel.rda.all.fulpcnm)
global.thresh=RsquareAdj(hel.rda.all.fulpcnm)$adj.r.squared
# now run step 2, the selection part

##INVERTS BY ECOSYSTEM
hel.rda.fulsoil = rda(tree.hel.soil[,8:27]~tree.hel.soil$Habitat)
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

#### CORE+EDGE ####
tree.hel.soil=tree.hel.soil[tree.hel.soil$EP.x=="Core"|tree.hel.soil$EP.x=="Edge",]
dim(tree.hel.soil)
rownames(tree.hel.soil)=tree.hel.soil[,1]
tree.hel.soil=na.exclude(tree.hel.soil)
# Here is the global analysis. Can proceed  Use adj. R square as additional stopping criterion.
colnames(tree.hel.soil)

hel.rda.fulsoil = rda(tree.hel.soil[,8:27], tree.hel.soil[,37:61])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERT BY TREE DATA
hel.rda.fulsoil = rda(tree.hel.soil[,8:27],tree.hel.soil[,c(70:104)])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERTS BY PCMN
#to determine spatial autocorrelation
# First we perform PCNM to get the vectors
colnames(tree.hel.soil)
all.geog.dist=vegdist(tree.hel.soil[,68:69],method="euclid")
all.pcnm1=pcnm(all.geog.dist)
all.pcnmvecs=all.pcnm1$vectors
# If you can get the PCNM library to run, you could do the line below to select only significantly structured PCNMs
#tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs[,which(all.pcnm1$Moran_I[,2]<0.05)])
tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs)
names(tree.hel.all.pcnm)
# Now run step 1, global analysis
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:27], tree.hel.all.pcnm[,106:137])
anova(hel.rda.all.fulpcnm)
RsquareAdj(hel.rda.all.fulpcnm)
global.thresh=RsquareAdj(hel.rda.all.fulpcnm)$adj.r.squared

##INVERTS BY ECOSYSTEM
hel.rda.fulsoil = rda(tree.hel.soil[,8:27]~tree.hel.soil$Habitat)
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

#### Core plots ####
tree.hel.soil=tree.hel.soil[tree.hel.soil$EP.x=="Core",]
dim(tree.hel.soil)
rownames(tree.hel.soil)=tree.hel.soil[,1]
tree.hel.soil=na.exclude(tree.hel.soil)
# Here is the global analysis. Can proceed  Use adj. R square as additional stopping criterion.
colnames(tree.hel.soil)
dim(tree.hel.soil)

hel.rda.fulsoil = rda(tree.hel.soil[,8:27], tree.hel.soil[,37:61])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERT BY TREE DATA
hel.rda.fulsoil = rda(tree.hel.soil[,8:27],tree.hel.soil[,c(70:104)])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERTS BY PCMN
#to determine spatial autocorrelation
# First we perform PCNM to get the vectors
colnames(tree.hel.soil)
all.geog.dist=vegdist(tree.hel.soil[,68:69],method="euclid")
all.pcnm1=pcnm(all.geog.dist)
all.pcnmvecs=all.pcnm1$vectors
# If you can get the PCNM library to run, you could do the line below to select only significantly structured PCNMs
#tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs[,which(all.pcnm1$Moran_I[,2]<0.05)])
tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs)
names(tree.hel.all.pcnm)
# Now run step 1, global analysis
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:27], tree.hel.all.pcnm[,106:124])
anova(hel.rda.all.fulpcnm)
RsquareAdj(hel.rda.all.fulpcnm)
global.thresh=RsquareAdj(hel.rda.all.fulpcnm)$adj.r.squared
# now run step 2, the selection part

##INVERTS BY ECOSYSTEM
hel.rda.fulsoil = rda(tree.hel.soil[,8:27]~tree.hel.soil$Habitat)
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared
```
```{r Functional Feeding Groups DATE3}
### USING THE CODE FOR SPLITTING TAXONOMIC GROUPS. data.agg will ONLY fit what we specify in the other code. NOTES CAN BE FOUND AT THE END OF THE CODE FOR EACH GROUP

#### All plots
tree.hel.soil=merge(date3.agg,soildata,by="Plot")
tree.hel.soil=merge(tree.hel.soil, tree.hel, by="Plot")

rownames(tree.hel.soil)=tree.hel.soil[,1]
tree.hel.soil=na.exclude(tree.hel.soil)
# Here is the global analysis. Can proceed  Use adj. R square as additional stopping criterion.
colnames(tree.hel.soil)
dim(tree.hel.soil)

hel.rda.fulsoil = rda(tree.hel.soil[,8:27], tree.hel.soil[,37:61])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERT BY TREE DATA
hel.rda.fulsoil = rda(tree.hel.soil[,8:27],tree.hel.soil[,c(70:104)])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERTS BY PCMN
#to determine spatial autocorrelation
# First we perform PCNM to get the vectors
colnames(tree.hel.soil)
all.geog.dist=vegdist(tree.hel.soil[,68:69],method="euclid")
all.pcnm1=pcnm(all.geog.dist)
all.pcnmvecs=all.pcnm1$vectors
# If you can get the PCNM library to run, you could do the line below to select only significantly structured PCNMs
#tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs[,which(all.pcnm1$Moran_I[,2]<0.05)])
tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs)
names(tree.hel.all.pcnm)
# Now run step 1, global analysis
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:27], tree.hel.all.pcnm[,106:142])
anova(hel.rda.all.fulpcnm)
RsquareAdj(hel.rda.all.fulpcnm)
global.thresh=RsquareAdj(hel.rda.all.fulpcnm)$adj.r.squared
# now run step 2, the selection part

##INVERTS BY ECOSYSTEM
hel.rda.fulsoil = rda(tree.hel.soil[,8:27]~tree.hel.soil$Habitat)
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

#### CORE+EDGE ####
tree.hel.soil=tree.hel.soil[tree.hel.soil$EP.x=="Core"|tree.hel.soil$EP.x=="Edge",]
dim(tree.hel.soil)
rownames(tree.hel.soil)=tree.hel.soil[,1]
tree.hel.soil=na.exclude(tree.hel.soil)
# Here is the global analysis. Can proceed  Use adj. R square as additional stopping criterion.
colnames(tree.hel.soil)

hel.rda.fulsoil = rda(tree.hel.soil[,8:27], tree.hel.soil[,37:61])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

##Forward selection
hel.rda.fulsoil.none = rda(tree.hel.soil[,8:27]~1)
hel.rda.fulsoil = rda(tree.hel.soil[,8:27], tree.hel.soil[,37:61])

hel.rda.fulsoil.full=rda(tree.hel.soil[,8:27]~tree.hel.soil$Ptot_long+tree.hel.soil$Po_long+tree.hel.soil$pH_long+tree.hel.soil$moist_long+tree.hel.soil$ps1_long+tree.hel.soil$ps2_long+tree.hel.soil$percc_long+tree.hel.soil$cton_long+tree.hel.soil$Ptot_nug+tree.hel.soil$Po_nug+tree.hel.soil$pH_nug+tree.hel.soil$moist_nug+tree.hel.soil$ps1_nug+tree.hel.soil$ps2_nug+tree.hel.soil$percc_nug+tree.hel.soil$pomc_nug+tree.hel.soil$cton_nug+tree.hel.soil$Ptot_short+tree.hel.soil$Po_short+tree.hel.soil$pH_short+tree.hel.soil$moist_short+tree.hel.soil$ps1_short+tree.hel.soil$percc_short+tree.hel.soil$pomc_short+tree.hel.soil$cton_short)

tree.sel=ordiR2step(hel.rda.fulsoil.none,scope=formula(hel.rda.fulsoil.full),Pin=0.05,R2scope=TRUE)
tree.sel

##Just the variables forward selected
hel.rda.fulsoil = rda(tree.hel.soil[,8:27], tree.hel.soil[,c(40,44,56)])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERT BY TREE DATA
hel.rda.fulsoil = rda(tree.hel.soil[,8:27],tree.hel.soil[,c(70:104)])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

##Forward selection
hel.rda.fulsoil.none = rda(tree.hel.soil[,8:27]~1)
hel.rda.fulsoil = rda(tree.hel.soil[,8:27], tree.hel.soil[,52:86])

hel.rda.fulsoil.full=rda(tree.hel.soil[,8:27]~tree.hel.soil$ACERUB+tree.hel.soil$ACESAC+tree.hel.soil$ACESIL+tree.hel.soil$BETALL+tree.hel.soil$CARCAR+tree.hel.soil$CARCOR+tree.hel.soil$CAROVA+tree.hel.soil$CARTOM+tree.hel.soil$CORFLO+tree.hel.soil$CRAPUN+tree.hel.soil$FAGAME+tree.hel.soil$FRAAME+tree.hel.soil$FRANIG+tree.hel.soil$HAMVIR+tree.hel.soil$LIRTUP+tree.hel.soil$MAGACU+tree.hel.soil$MALCOR+tree.hel.soil$NYSSYL+tree.hel.soil$OSTVIR+tree.hel.soil$PLAOCC+tree.hel.soil$POPDEL+tree.hel.soil$POPGRA+tree.hel.soil$PRUSER+tree.hel.soil$QUEALB+tree.hel.soil$QUERUB+tree.hel.soil$SALNIG+tree.hel.soil$SASALB+tree.hel.soil$TILAME+tree.hel.soil$TOXVER+tree.hel.soil$ULMAME+tree.hel.soil$ULMRUB+tree.hel.soil$ULMSP+tree.hel.soil$VIBLEN)

tree.sel=ordiR2step(hel.rda.fulsoil.none,scope=formula(hel.rda.fulsoil.full),Pin=0.05,R2scope=TRUE)
tree.sel

##Just the variables forward selected
hel.rda.fulsoil = rda(tree.hel.soil[,8:27], tree.hel.soil[,c(70:104)])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERTS BY PCMN
#to determine spatial autocorrelation
# First we perform PCNM to get the vectors
colnames(tree.hel.soil)
all.geog.dist=vegdist(tree.hel.soil[,68:69],method="euclid")
all.pcnm1=pcnm(all.geog.dist)
all.pcnmvecs=all.pcnm1$vectors
# If you can get the PCNM library to run, you could do the line below to select only significantly structured PCNMs
#tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs[,which(all.pcnm1$Moran_I[,2]<0.05)])
tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs)
names(tree.hel.all.pcnm)
# Now run step 1, global analysis
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:27], tree.hel.all.pcnm[,106:136])
anova(hel.rda.all.fulpcnm)
RsquareAdj(hel.rda.all.fulpcnm)
global.thresh=RsquareAdj(hel.rda.all.fulpcnm)$adj.r.squared

#forward selection for our PCNM variables
hel.rda.all.pcnm.none=rda(tree.hel.all.pcnm[,8:27]~1)
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:27], tree.hel.all.pcnm[,106:136])

hel.rda.all.pcnm.full=rda(tree.hel.all.pcnm[,8:27]~tree.hel.all.pcnm$PCNM1+tree.hel.all.pcnm$PCNM2+tree.hel.all.pcnm$PCNM3+tree.hel.all.pcnm$PCNM4+tree.hel.all.pcnm$PCNM5+tree.hel.all.pcnm$PCNM6+tree.hel.all.pcnm$PCNM7+tree.hel.all.pcnm$PCNM8+tree.hel.all.pcnm$PCNM9+tree.hel.all.pcnm$PCNM10+tree.hel.all.pcnm$PCNM11+tree.hel.all.pcnm$PCNM12+tree.hel.all.pcnm$PCNM13+tree.hel.all.pcnm$PCNM14+tree.hel.all.pcnm$PCNM15+tree.hel.all.pcnm$PCNM16+tree.hel.all.pcnm$PCNM17+tree.hel.all.pcnm$PCNM18+tree.hel.all.pcnm$PCNM19+tree.hel.all.pcnm$PCNM20+tree.hel.all.pcnm$PCNM21+tree.hel.all.pcnm$PCNM22+tree.hel.all.pcnm$PCNM23+tree.hel.all.pcnm$PCNM24+tree.hel.all.pcnm$PCNM25+tree.hel.all.pcnm$PCNM26+tree.hel.all.pcnm$PCNM27+tree.hel.all.pcnm$PCNM28+tree.hel.all.pcnm$PCNM29+tree.hel.all.pcnm$PCNM30+tree.hel.all.pcnm$PCNM31)

tree.sel=ordiR2step(hel.rda.fulsoil.none,scope=formula(hel.rda.fulsoil.full),Pin=0.05,R2scope=TRUE)
tree.sel

## Variance partitioning
varpart(tree.hel.all.pcnm[,8:27], tree.hel.all.pcnm[,c(52:86)], tree.hel.all.pcnm[,c(106:136)],tree.hel.all.pcnm[,c(40,44,56)])
## Check to see if it's significant when PCNM and soil come first.
hel.rda.all.partpcnm=rda(tree.hel.all.pcnm[,5:205], tree.hel.all.pcnm[,c(258,255,272,259,276)], tree.hel.all.pcnm[,c(246,253)])
anova(hel.rda.all.partpcnm)
# Yes.
hel.rda.all.partsoil=rda(tree.hel.all.pcnm[,5:205], tree.hel.all.pcnm[,c(246,253)], tree.hel.all.pcnm[,c(258,255,272,259,276)])
anova(hel.rda.all.partsoil)
# Yes.

##INVERTS BY ECOSYSTEM
hel.rda.fulsoil = rda(tree.hel.soil[,8:27]~tree.hel.soil$Habitat)
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

#### Core plots ####
tree.hel.soil=tree.hel.soil[tree.hel.soil$EP.x=="Core",]
dim(tree.hel.soil)
rownames(tree.hel.soil)=tree.hel.soil[,1]
tree.hel.soil=na.exclude(tree.hel.soil)
# Here is the global analysis. Can proceed  Use adj. R square as additional stopping criterion.
colnames(tree.hel.soil)
dim(tree.hel.soil)

hel.rda.fulsoil = rda(tree.hel.soil[,8:27], tree.hel.soil[,37:61])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

##Forward selection
hel.rda.fulsoil.none = rda(tree.hel.soil[,8:27]~1)
hel.rda.fulsoil = rda(tree.hel.soil[,8:27], tree.hel.soil[,37:61])

hel.rda.fulsoil.full=rda(tree.hel.soil[,8:27]~tree.hel.soil$Ptot_long+tree.hel.soil$Po_long+tree.hel.soil$pH_long+tree.hel.soil$moist_long+tree.hel.soil$ps1_long+tree.hel.soil$ps2_long+tree.hel.soil$percc_long+tree.hel.soil$cton_long+tree.hel.soil$Ptot_nug+tree.hel.soil$Po_nug+tree.hel.soil$pH_nug+tree.hel.soil$moist_nug+tree.hel.soil$ps1_nug+tree.hel.soil$ps2_nug+tree.hel.soil$percc_nug+tree.hel.soil$pomc_nug+tree.hel.soil$cton_nug+tree.hel.soil$Ptot_short+tree.hel.soil$Po_short+tree.hel.soil$pH_short+tree.hel.soil$moist_short+tree.hel.soil$ps1_short+tree.hel.soil$percc_short+tree.hel.soil$pomc_short+tree.hel.soil$cton_short)

tree.sel=ordiR2step(hel.rda.fulsoil.none,scope=formula(hel.rda.fulsoil.full),Pin=0.05,R2scope=TRUE)
tree.sel

##Just the variables forward selected
hel.rda.fulsoil = rda(tree.hel.soil[,8:27], tree.hel.soil[,c(40)])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared


###INVERT BY TREE DATA
hel.rda.fulsoil = rda(tree.hel.soil[,8:27],tree.hel.soil[,c(70:104)])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERTS BY PCMN
#to determine spatial autocorrelation
# First we perform PCNM to get the vectors
colnames(tree.hel.soil)
all.geog.dist=vegdist(tree.hel.soil[,68:69],method="euclid")
all.pcnm1=pcnm(all.geog.dist)
all.pcnmvecs=all.pcnm1$vectors
# If you can get the PCNM library to run, you could do the line below to select only significantly structured PCNMs
#tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs[,which(all.pcnm1$Moran_I[,2]<0.05)])
tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs)
names(tree.hel.all.pcnm)
# Now run step 1, global analysis
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:27], tree.hel.all.pcnm[,106:124])
anova(hel.rda.all.fulpcnm)
RsquareAdj(hel.rda.all.fulpcnm)
global.thresh=RsquareAdj(hel.rda.all.fulpcnm)$adj.r.squared
# now run step 2, the selection part

#forward selection for our PCNM variables
hel.rda.all.pcnm.none=rda(tree.hel.all.pcnm[,8:27]~1)
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:27], tree.hel.all.pcnm[,83:109])

hel.rda.all.pcnm.full=rda(tree.hel.all.pcnm[,8:27]~tree.hel.all.pcnm$PCNM1+tree.hel.all.pcnm$PCNM2+tree.hel.all.pcnm$PCNM3+tree.hel.all.pcnm$PCNM4+tree.hel.all.pcnm$PCNM5+tree.hel.all.pcnm$PCNM6+tree.hel.all.pcnm$PCNM7+tree.hel.all.pcnm$PCNM8+tree.hel.all.pcnm$PCNM9+tree.hel.all.pcnm$PCNM10+tree.hel.all.pcnm$PCNM11+tree.hel.all.pcnm$PCNM12+tree.hel.all.pcnm$PCNM13+tree.hel.all.pcnm$PCNM14+tree.hel.all.pcnm$PCNM15+tree.hel.all.pcnm$PCNM16+tree.hel.all.pcnm$PCNM17)

tree.sel=ordiR2step(hel.rda.all.pcnm.none,scope=formula(hel.rda.all.pcnm.full),Pin=0.05,R2scope=TRUE)
tree.sel

##Just the variables forward selected
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:27], tree.hel.all.pcnm[,c(95:96,98,101:102)])
anova(hel.rda.all.fulpcnm)
RsquareAdj(hel.rda.all.fulpcnm)
global.thresh=RsquareAdj(hel.rda.all.fulpcnm)$adj.r.squared

##INVERTS BY ECOSYSTEM
hel.rda.fulsoil = rda(tree.hel.soil[,8:27]~tree.hel.soil$Habitat)
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared
```
```{r Functional Feeding Groups DATE4}
### USING THE CODE FOR SPLITTING TAXONOMIC GROUPS. data.agg will ONLY fit what we specify in the other code. NOTES CAN BE FOUND AT THE END OF THE CODE FOR EACH GROUP

#### All plots
tree.hel.soil=merge(date4.agg,soildata,by="Plot")
tree.hel.soil=merge(tree.hel.soil, tree.hel, by="Plot")

rownames(tree.hel.soil)=tree.hel.soil[,1]
tree.hel.soil=na.exclude(tree.hel.soil)
# Here is the global analysis. Can proceed  Use adj. R square as additional stopping criterion.
colnames(tree.hel.soil)
dim(tree.hel.soil)

hel.rda.fulsoil = rda(tree.hel.soil[,8:27], tree.hel.soil[,37:61])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERT BY TREE DATA
hel.rda.fulsoil = rda(tree.hel.soil[,8:27],tree.hel.soil[,c(70:104)])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERTS BY PCMN
#to determine spatial autocorrelation
# First we perform PCNM to get the vectors
colnames(tree.hel.soil)
all.geog.dist=vegdist(tree.hel.soil[,68:69],method="euclid")
all.pcnm1=pcnm(all.geog.dist)
all.pcnmvecs=all.pcnm1$vectors
# If you can get the PCNM library to run, you could do the line below to select only significantly structured PCNMs
#tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs[,which(all.pcnm1$Moran_I[,2]<0.05)])
tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs)
names(tree.hel.all.pcnm)
# Now run step 1, global analysis
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:27], tree.hel.all.pcnm[,106:138])
anova(hel.rda.all.fulpcnm)
RsquareAdj(hel.rda.all.fulpcnm)
global.thresh=RsquareAdj(hel.rda.all.fulpcnm)$adj.r.squared
# now run step 2, the selection part

##INVERTS BY ECOSYSTEM
hel.rda.fulsoil = rda(tree.hel.soil[,8:27]~tree.hel.soil$Habitat)
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

#### CORE+EDGE ####
tree.hel.soil=tree.hel.soil[tree.hel.soil$EP.x=="Core"|tree.hel.soil$EP.x=="Edge",]
dim(tree.hel.soil)
rownames(tree.hel.soil)=tree.hel.soil[,1]
tree.hel.soil=na.exclude(tree.hel.soil)
# Here is the global analysis. Can proceed  Use adj. R square as additional stopping criterion.
colnames(tree.hel.soil)

hel.rda.fulsoil = rda(tree.hel.soil[,8:27], tree.hel.soil[,37:61])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERT BY TREE DATA
hel.rda.fulsoil = rda(tree.hel.soil[,8:27],tree.hel.soil[,c(70:104)])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERTS BY PCMN
#to determine spatial autocorrelation
# First we perform PCNM to get the vectors
colnames(tree.hel.soil)
all.geog.dist=vegdist(tree.hel.soil[,68:69],method="euclid")
all.pcnm1=pcnm(all.geog.dist)
all.pcnmvecs=all.pcnm1$vectors
# If you can get the PCNM library to run, you could do the line below to select only significantly structured PCNMs
#tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs[,which(all.pcnm1$Moran_I[,2]<0.05)])
tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs)
names(tree.hel.all.pcnm)
# Now run step 1, global analysis
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:27], tree.hel.all.pcnm[,106:135])
anova(hel.rda.all.fulpcnm)
RsquareAdj(hel.rda.all.fulpcnm)
global.thresh=RsquareAdj(hel.rda.all.fulpcnm)$adj.r.squared

##INVERTS BY ECOSYSTEM
hel.rda.fulsoil = rda(tree.hel.soil[,8:27]~tree.hel.soil$Habitat)
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

#### Core plots ####
tree.hel.soil=tree.hel.soil[tree.hel.soil$EP.x=="Core",]
dim(tree.hel.soil)
rownames(tree.hel.soil)=tree.hel.soil[,1]
tree.hel.soil=na.exclude(tree.hel.soil)
# Here is the global analysis. Can proceed  Use adj. R square as additional stopping criterion.
colnames(tree.hel.soil)
dim(tree.hel.soil)

hel.rda.fulsoil = rda(tree.hel.soil[,8:27], tree.hel.soil[,37:61])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERT BY TREE DATA
hel.rda.fulsoil = rda(tree.hel.soil[,8:27],tree.hel.soil[,c(70:104)])
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared

###INVERTS BY PCMN
#to determine spatial autocorrelation
# First we perform PCNM to get the vectors
colnames(tree.hel.soil)
all.geog.dist=vegdist(tree.hel.soil[,68:69],method="euclid")
all.pcnm1=pcnm(all.geog.dist)
all.pcnmvecs=all.pcnm1$vectors
# If you can get the PCNM library to run, you could do the line below to select only significantly structured PCNMs
#tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs[,which(all.pcnm1$Moran_I[,2]<0.05)])
tree.hel.all.pcnm=cbind(tree.hel.soil,all.pcnmvecs)
names(tree.hel.all.pcnm)
# Now run step 1, global analysis
hel.rda.all.fulpcnm=rda(tree.hel.all.pcnm[,8:27], tree.hel.all.pcnm[,106:124])
anova(hel.rda.all.fulpcnm)
RsquareAdj(hel.rda.all.fulpcnm)
global.thresh=RsquareAdj(hel.rda.all.fulpcnm)$adj.r.squared
# now run step 2, the selection part

##INVERTS BY ECOSYSTEM
hel.rda.fulsoil = rda(tree.hel.soil[,8:27]~tree.hel.soil$Habitat)
anova(hel.rda.fulsoil)
RsquareAdj(hel.rda.fulsoil)
global.thresh=RsquareAdj(hel.rda.fulsoil)$adj.r.squared
```
-Decomposers never decoupled. No habitat effects.
-Fungi showed sig habitat effects on Date 4 core. No decoupling
-Herbivores had lot of significance in date 3 that we need to expand out, but I'm unwilling to do today. There was only a habitat effect on the Date 3.
-Leaves no signs of decoupling, no significant habitat effects.
-Pollinators no decoupling patterns, habitat effects on date 4.
-Parasites decoupled from soil on date 3 (soil effect in core, not in core+edge or all); sig habitat effect on date 3. No other significances.
-Predators no decoupling. Significant habitat effect in the cores on Dates 1, 2, 4.
-Sap feeders show PCNM effects on date 1 - need to do forward selection still. Significant habitat effects in all locations on dates 1,2,4 but not anywhere in 3.
-Scavengers had no significance anywhere on the first 3 dates and then had a bunch of significance on the fourth date that needs to be looked at more.
-Sugars had the occassional significance to pcnm on date 3 in the middle, but nothing that shows decoupling. No significant habitat effects.
-Woodfeeding organisms showed no significance anywhere.